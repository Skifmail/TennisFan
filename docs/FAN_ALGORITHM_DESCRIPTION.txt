================================================================================
                    АЛГОРИТМ FAN-ТУРНИРОВ
================================================================================
1. ЧТО ТАКОЕ FAN
================================================================================

FAN — это формат турнира с одноэтапной сеткой на выбывание (single elimination).
Турнир проводится при любом количестве участников от 2 до максимума (например,
до 16 или 32). Ключевые особенности:

  • Посев по рейтингу — сильнейшие не встречаются в первом круге
  • Очки начисляются при вылете (чем дальше прошёл — тем больше очков)
  • Есть «подвал» для проигравших в первом круге — все играют минимум 2 матча
  • При нечётном числе участников используется «Свободный круг» (bye)


================================================================================
2. КОГДА ФОРМИРУЕТСЯ СЕТКА
================================================================================

Сетка формируется автоматически после истечения дедлайна регистрации.
В этот момент:

  • Список участников фиксируется
  • Регистрация закрывается
  • Система создаёт матчи первого круга

Сетку можно также сформировать вручную через админку (кнопка «Сформировать
сетку»).


================================================================================
3. ПОСЕВ И ПАРЫ ПЕРВОГО КРУГА
================================================================================

Участники сортируются по рейтингу (total_points) от большего к меньшему.
Нумерация: 1-й — сильнейший, 2-й — второй по силе, и т.д.

Правило формирования пар в первом круге:

  • 1-й сеяный играет с последним (N-м)
  • 2-й — с предпоследним (N-1)
  • 3-й — с (N-2)
  • и так далее

Пример для 8 участников:
  Матч 1: 1 vs 8
  Матч 2: 2 vs 7
  Матч 3: 3 vs 6
  Матч 4: 4 vs 5

Так сильнейшие не встречаются в первом круге.


================================================================================
4. НЕЧЁТНОЕ КОЛИЧЕСТВО УЧАСТНИКОВ — ПЕРВЫЙ КРУГ
================================================================================

Если участников нечётное число (например, 9, 11, 15), одному игроку не хватает
пары. В этом случае используется служебный игрок «Свободный круг» (bye).

Правило: свободный круг получает СИЛЬНЕЙШИЙ (1-й сеяный).

  • Создаётся матч «1-й сеяный vs Свободный круг»
  • Матч сразу считается завершённым (walkover) — 1-й сеяный побеждает
  • Игрок автоматически выходит во второй круг без игры

Пример для 9 участников:
  Матч 1: 1 vs Свободный круг (автопобеда 1-го)
  Матч 2: 2 vs 9
  Матч 3: 3 vs 8
  Матч 4: 4 vs 7
  Матч 5: 5 vs 6

Итого: 5 матчей, 5 победителей выходят во второй круг.


================================================================================
5. ПРОДВИЖЕНИЕ ПОБЕДИТЕЛЕЙ — ВТОРОЙ КРУГ И ДАЛЬШЕ
================================================================================

После завершения матча победитель переходит в следующий раунд. Когда оба
«фидерных» матча (чьи победители должны встретиться) завершены, создаётся
новый матч следующего раунда.

Структура:
  • Победители матчей 1 и 2 → матч 2-го круга №1
  • Победители матчей 3 и 4 → матч 2-го круга №2
  • и т.д.


================================================================================
6. НЕЧЁТНОЕ КОЛИЧЕСТВО ПОБЕДИТЕЛЕЙ — ВТОРОЙ КРУГ И ПОЛУФИНАЛ
================================================================================

Если в раунде нечётное число победителей (например, 5 вышли из 1-го круга),
одному не хватает пары для следующего раунда.

Правило: свободный круг получает СИЛЬНЕЙШИЙ по рейтингу среди победителей
этого раунда.

  • Система находит игрока с максимальным рейтингом среди всех победителей
  • Создаётся матч «этот игрок vs Свободный круг» (walkover)
  • Игрок автоматически выходит в следующий раунд
  • Остальные победители играют между собой в обычных матчах

Пример: 10 участников → 5 победителей R1. Один (сильнейший) получает bye
во 2-й круг, остальные 4 играют 2 матча. В полуфинал выходят 3 человека
(2 победителя + 1 с bye). В полуфинале снова один (сильнейший) получает bye
в финал, двое других играют между собой. В финале встречаются 2 человека —
bye в финале НЕ бывает, финал всегда между двумя реальными игроками.


================================================================================
7. ПОДВАЛ
================================================================================

Чтобы проигравшие в первом круге не вылетали после одного матча, для них
создаётся «подвал» — дополнительная сетка.

  • Подвал создаётся автоматически после завершения ВСЕХ матчей 1-го круга
  • Участники — все проигравшие в R1 (кроме «Свободного круга», если он был)
  • Пары: 1-й проигравший vs последний, 2-й vs предпоследний, и т.д.

При нечётном числе проигравших (например, 5):
  • 4 играют в 2 матчах
  • 5-му (среднему по порядку) даётся матч vs Свободный круг (walkover)
  • В итоге все проигравшие R1 сыграли минимум 2 матча

Очки за подвал: проигравшие в подвале получают очки как за вылет в 1-м круге
(они уже вылетели в R1, подвал — дополнительная игра).


================================================================================
8. СИСТЕМА ОЧКОВ
================================================================================

Очки начисляются при вылете или при достижении финала/победы. Чем дальше
прошёл игрок — тем больше очков. Значения по умолчанию (настраиваются в турнире):

  • Вылет в 1-м круге (основная сетка):     10 очков
  • Вылет во 2-м круге:                     25 очков
  • Вылет в полуфинале:                     45 очков
  • Финалист (проиграл в финале):           70 очков
  • Победитель турнира:                    100 очков

Когда начисляются:
  • При вылете — сразу после завершения матча, в котором игрок проиграл
  • Финалист и победитель — после завершения финального матча

Очки добавляются к рейтингу игрока (total_points) только после полного
завершения турнира (когда сыгран финал).


================================================================================
9. ПРОСРОЧКА ДЕДЛАЙНА МАТЧА
================================================================================

У каждого матча есть дедлайн (по умолчанию 7 дней на раунд). Если матч не
сыгран к дедлайну:

  • Победа присуждается игроку с более высоким рейтингом
  • При равенстве рейтинга — игроку с меньшим id
  • Игроки получают уведомления о технической победе/поражении
  • Победитель продвигается дальше, проигравший получает очки за вылет

Обработка просроченных матчей выполняется автоматически (по расписанию, cron)
или вручную через админку.


================================================================================
10. ЗАВЕРШЕНИЕ ТУРНИРА
================================================================================

Турнир считается завершённым, когда сыгран финальный матч (между двумя
реальными игроками, без Свободного круга).

При завершении:
  • Финалисту и победителю начисляются очки (70 и 100 по умолчанию)
  • Все накопленные очки участников (за вылет в своём раунде) добавляются
    к их общему рейтингу (total_points)
  • Статус турнира меняется на «Завершён»


================================================================================
11. СТРУКТУРА РАУНДОВ (ПРИМЕРЫ)
================================================================================

  • 8 участников:  R1 (4 матча) → R2 (2 матча) → Финал (1 матч)
  • 10 участников: R1 (5 матчей) → R2 (2+bye) → Полуфинал (1+bye) → Финал
  • 16 участников: R1 (8) → R2 (4) → Полуфинал (2) → Финал (1)

Количество раундов до финала: ceil(log2(N)). Например, для 10 участников
нужно 4 раунда (R1, R2, Полуфинал, Финал).