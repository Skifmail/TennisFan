# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ —á–µ—Ä–µ–∑ Telegram

## –û–±—â–∞—è —Å—Ö–µ–º–∞

```
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å–∞–π—Ç–µ]                    [–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤ Telegram]
        |                                            |
        | 1. –§–æ—Ä–º–∞ (—Ç–µ–º–∞, —Å–æ–æ–±—â–µ–Ω–∏–µ)                  |
        v                                            |
   Django: SupportMessage                            |
        | 2. sendMessage(ADMIN_CHAT_ID)  ----------> –°–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ —Å #id
        |    —Å–æ—Ö—Ä–∞–Ω—è–µ–º admin_telegram_message_id     |
        |                                            | 3. Reply –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
        | 4. Webhook: reply_to_message               |
        v    –∏—â–µ–º SupportMessage –ø–æ message_id       |
   Django: SupportMessage (is_from_admin=True)       |
        | 5. sendMessage(USER_CHAT_ID)  <---------- –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram
        v
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Telegram –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç]

–î–∞–ª—å—à–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –±–æ—Ç—É –≤ Telegram -> —Å–æ—Ö—Ä–∞–Ω—è–µ–º, –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º –∞–¥–º–∏–Ω—É.
–ê–¥–º–∏–Ω –æ—Ç–≤–µ—á–∞–µ—Ç reply -> –æ—Ç–≤–µ—Ç —É—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –¥–∏–∞–ª–æ–≥.
```

## –°–≤—è–∑—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üî Telegram

- **Telegram –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É –ø–∏—Å–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–µ—Ä–≤—ã–º.** –ü–æ—ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Ö–æ—Ç—è –±—ã —Ä–∞–∑ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç.
- –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –Ω–∞ —Å–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å—Å—ã–ª–∫—É –≤–∏–¥–∞ `https://t.me/BotUsername?start=TOKEN`.
- –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—ã `/start` (—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `TOKEN`) –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç `telegram_chat_id` –∫ –∞–∫–∫–∞—É–Ω—Ç—É –Ω–∞ —Å–∞–π—Ç–µ (–º–æ–¥–µ–ª—å `UserTelegramLink`).
- –¢–æ–∫–µ–Ω –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π, —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 24 —á–∞—Å–∞.

## –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### UserTelegramLink

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| user | OneToOne ‚Üí User (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–π—Ç–∞) |
| telegram_chat_id | BigInteger, nullable, unique ‚Äî chat_id –≤ Telegram |
| binding_token | –¢–æ–∫–µ–Ω –¥–ª—è —Å—Å—ã–ª–∫–∏ –ø—Ä–∏–≤—è–∑–∫–∏ (t.me/bot?start=TOKEN) |
| token_created_at | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ (—Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ 24 —á) |

### SupportMessage

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| user | FK ‚Üí User |
| subject | –¢–µ–º–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Å —Ñ–æ—Ä–º—ã —Å —Å–∞–π—Ç–∞) |
| text | –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è |
| is_from_admin | True ‚Äî –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∞, False ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| created_at | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è |
| admin_telegram_message_id | ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram (–Ω–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É), –¥–ª—è —Å–≤—è–∑–∏ reply –∞–¥–º–∏–Ω–∞ —Å –∑–∞–ø–∏—Å—å—é |

**–°–≤—è–∑—å reply –∞–¥–º–∏–Ω–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:** –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω—É –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è Telegram API `sendMessage`, –≤ –æ—Ç–≤–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç `message_id`. –ú—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –≤ `SupportMessage.admin_telegram_message_id`. –ö–æ–≥–¥–∞ –∞–¥–º–∏–Ω –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–û—Ç–≤–µ—Ç–∏—Ç—å¬ª –≤ Telegram, –≤ webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç `message.reply_to_message.message_id` ‚Äî –ø–æ –Ω–µ–º—É –Ω–∞—Ö–æ–¥–∏–º `SupportMessage`, –ø–æ–ª—É—á–∞–µ–º `user`, –ø–æ `UserTelegramLink` ‚Äî `telegram_chat_id` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–º—É –æ—Ç–≤–µ—Ç.

## –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

| URL | –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|--------|----------|
| `/support/` | GET | –§–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ (—Ç–µ–º–∞, —Å–æ–æ–±—â–µ–Ω–∏–µ) |
| `/support/` | POST | –°–æ–∑–¥–∞–Ω–∏–µ SupportMessage, –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–¥–º–∏–Ω—É, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ø–µ—Ö–∞ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Å—ã–ª–∫–æ–π –ø—Ä–∏–≤—è–∑–∫–∏) |
| `/api/feedback/submit/` | POST (JSON) | –¢–æ –∂–µ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞: —Å–æ–∑–¥–∞–Ω–∏–µ SupportMessage, –æ—Ç–≤–µ—Ç JSON —Å `telegram_binding_url` –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ |
| `/api/feedback/threads/` | GET | –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (SupportMessage) –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ |
| `/telegram/support-webhook/` | POST | Webhook –±–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (TELEGRAM_SUPPORT_BOT_TOKEN) |

## –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–∞** (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω `TELEGRAM_WEBHOOK_SECRET`): –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Telegram-Bot-Api-Secret-Token` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å.
2. **–û—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∞:** `message.reply_to_message` –µ—Å—Ç—å, `chat.id == TELEGRAM_ADMIN_CHAT_ID`. –ò—â–µ–º `SupportMessage` –ø–æ `admin_telegram_message_id = reply_to_message.message_id`, –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–º—É –æ—Ç–≤–µ—Ç –≤ Telegram, —Å–æ–∑–¥–∞—ë–º `SupportMessage(is_from_admin=True)`.
3. **/start —Å —Ç–æ–∫–µ–Ω–æ–º:** –ª–∏—á–Ω—ã–π —á–∞—Ç, —Ç–µ–∫—Å—Ç `/start TOKEN`. –ò—â–µ–º `UserTelegramLink` –ø–æ `binding_token=TOKEN`, –∑–∞–ø–∏—Å—ã–≤–∞–µ–º `telegram_chat_id`, –æ—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.
4. **–û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** –ª–∏—á–Ω—ã–π —á–∞—Ç, –Ω–µ reply. –ò—â–µ–º `UserTelegramLink` –ø–æ `telegram_chat_id`. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Äî —Å–æ–∑–¥–∞—ë–º `SupportMessage`, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—É, —Å–æ—Ö—Ä–∞–Ω—è–µ–º `admin_telegram_message_id`. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ—Å–∏–º —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç –ø–æ —Å—Å—ã–ª–∫–µ —Å —Å–∞–π—Ç–∞.

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **Whitelist –∞–¥–º–∏–Ω–∞:** –æ—Ç–≤–µ—Ç—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `message.chat.id == TELEGRAM_ADMIN_CHAT_ID` (–æ—Ç–≤–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ —á–∞—Ç–∞ –∞–¥–º–∏–Ω–∞ —Å –±–æ—Ç–æ–º).
- **–ó–∞—â–∏—Ç–∞ webhook:** –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ `TELEGRAM_SUPPORT_WEBHOOK_SECRET`; –ø—Ä–∏ setWebhook –∑–∞–¥–∞—ë—Ç—Å—è `secret_token`, Telegram –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –µ–≥–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ view, 403 –ø—Ä–∏ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏.
- –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î (Django ORM), Telegram –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–æ—Ç–¥–µ–ª—å–Ω—ã–π –±–æ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏** (–Ω–µ –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π).

1. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**
   - **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:** `TELEGRAM_SUPPORT_BOT_TOKEN`, `TELEGRAM_ADMIN_CHAT_ID`.
   - **–ü–æ –∂–µ–ª–∞–Ω–∏—é:** `TELEGRAM_SUPPORT_BOT_USERNAME` ‚Äî –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω, username –±–µ—Ä—ë—Ç—Å—è —á–µ—Ä–µ–∑ getMe; `TELEGRAM_SUPPORT_WEBHOOK_SECRET` ‚Äî –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω, webhook –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ–∫—Ä–µ—Ç (–≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç).

2. **Webhook –±–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏**
   - URL: `https://–≤–∞—à-–¥–æ–º–µ–Ω/telegram/support-webhook/`
   - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (–ø–æ–¥—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω **–±–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏**):  
     `https://api.telegram.org/bot<TELEGRAM_SUPPORT_BOT_TOKEN>/setWebhook?url=https://–≤–∞—à-–¥–æ–º–µ–Ω/telegram/support-webhook/`  
     –° —Å–µ–∫—Ä–µ—Ç–æ–º:  
     `...&secret_token=<TELEGRAM_SUPPORT_WEBHOOK_SECRET>`

3. **–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–∏–≤—è–∑–æ–∫** (–ø–æ—Å–ª–µ —Å–º–µ–Ω—ã –±–æ—Ç–∞ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–±–Ω—ã—Ö):
   ```bash
   python manage.py clear_telegram_support_bindings
   ```
   –° –æ–ø—Ü–∏–µ–π `--dry-run` ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π.

4. **–ú–∏–≥—Ä–∞—Ü–∏–∏**
   ```bash
   python manage.py migrate core
   ```

## –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏

**–ê–¥–º–∏–Ω—É (–ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è —Å —Å–∞–π—Ç–∞ –∏–ª–∏ –∏–∑ Telegram):**

```python
from apps.core import telegram_support as tg_support

text = tg_support.format_support_message_to_admin(
    support_message_id=support_msg.pk,
    user_display=user.get_full_name() or user.email,
    user_email=user.email or "",
    subject=subject,
    text=message,
    source="—Å–∞–π—Ç",  # –∏–ª–∏ "Telegram"
)
msg_id, ok = tg_support.send_to_admin(text)
if ok and msg_id:
    support_msg.admin_telegram_message_id = msg_id
    support_msg.save(update_fields=["admin_telegram_message_id"])
```

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–æ—Ç–≤–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏):**

```python
from apps.core import telegram_support as tg_support

# link = UserTelegramLink.objects.get(user=user)
if link.telegram_chat_id:
    tg_support.send_to_user(link.telegram_chat_id, "üì© –û—Ç–≤–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏:\n\n" + reply_text)
```

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è polling ‚Äî —Ç–æ–ª—å–∫–æ webhook.
- –ü–∏—Å–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω —Å–∞–º –Ω–∞–ø–∏—Å–∞–ª –±–æ—Ç—É (–∏–ª–∏ –ø–µ—Ä–µ—à—ë–ª –ø–æ —Å—Å—ã–ª–∫–µ –∏ –æ—Ç–ø—Ä–∞–≤–∏–ª /start).
- –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ‚Äî —Ç–æ–ª—å–∫–æ –≤ –ë–î (PostgreSQL/Django), –Ω–µ –≤ Telegram.
