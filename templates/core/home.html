{% extends 'base.html' %}
{% load static %}

{% block title %}Главная{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero">
    <div class="hero-image-wrapper">
        <img src="{% static 'images/hero_image_1.png' %}" alt="Tennis Player" class="hero-image">
    </div>
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title">
                Любительские турниры<br>
                по <span>теннису</span>
            </h1>
            <p class="hero-text">
                Аналог ATP Tour для любителей. Равные соперники, честная игра,
                закрытое сообщество игроков в Москве и Санкт-Петербурге.
            </p>
            <div class="hero-buttons">
                {% if not user.is_authenticated %}
                <a href="{% url 'register' %}" class="btn btn-primary btn-lg">Регистрация</a>
                {% endif %}
                <a href="{% url 'rules' %}" class="btn btn-outline btn-lg">Как это работает</a>
            </div>
        </div>
    </div>
</section>

<!-- Tournaments with filters -->
<section class="section">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Турниры</h2>
            <div class="d-flex gap-2" style="flex-wrap: wrap;">
                <a href="{% url 'tournament_list' %}" class="btn btn-outline">Все турниры</a>
                <a href="?" class="btn btn-ghost">Сбросить фильтры</a>
            </div>
        </div>

        <form method="get" class="card" style="margin-bottom: var(--spacing-xl);">
            <div class="card-body" style="display: grid; gap: var(--spacing-md); grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                <div class="form-group" style="margin: 0;">
                    <label class="form-label">Город</label>
                    <select name="city" class="form-control">
                        <option value="">Все</option>
                        {% for value, label in city_choices %}
                        <option value="{{ value }}" {% if current_filters.city == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label class="form-label">Уровень</label>
                    <select name="category" class="form-control">
                        <option value="">Все</option>
                        {% for value, label in category_choices %}
                        <option value="{{ value }}" {% if current_filters.category == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label class="form-label">Пол</label>
                    <select name="gender" class="form-control">
                        <option value="">Все</option>
                        {% for value, label in gender_choices %}
                        <option value="{{ value }}" {% if current_filters.gender == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label class="form-label">Продолжительность</label>
                    <select name="duration" class="form-control">
                        <option value="">Все</option>
                        {% for value, label in duration_choices %}
                        <option value="{{ value }}" {% if current_filters.duration == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="margin: 0; display: flex; flex-direction: column; align-items: stretch;">
                    <label class="form-label" style="visibility: hidden;">Применить</label>
                    <button type="submit" class="btn btn-primary" style="width: 100%; height: 100%;">Применить</button>
                </div>
            </div>
        </form>

        <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
            {% for tournament in filtered_tournaments %}
            <div class="card" style="position: relative; cursor: pointer;" data-url="{% url 'tournament_detail' slug=tournament.slug %}" onclick="window.location.href=this.dataset.url;">
                <div class="card-body" style="display: flex; gap: var(--spacing-lg); align-items: center;">
                    {% if tournament.image %}
                    <img src="{{ tournament.image.url }}" alt="{{ tournament.name }}" style="width: 160px; height: 160px; object-fit: cover; border-radius: var(--radius-md); flex-shrink: 0;">
                    {% else %}
                    <div style="width: 160px; height: 160px; background: var(--color-bg-elevated); border-radius: var(--radius-md); flex-shrink: 0;"></div>
                    {% endif %}
                    
                    <div style="flex: 1; display: flex; flex-direction: column; gap: var(--spacing-sm);">
                        <div class="d-flex gap-1" style="flex-wrap: wrap;">
                            <span class="badge">{{ tournament.get_city_display }}</span>
                            <span class="badge">{{ tournament.get_category_display }}</span>
                            <span class="badge">{{ tournament.get_gender_display }}</span>
                            <span class="badge">{{ tournament.get_duration_display }}</span>
                            {% if tournament.max_participants %}
                                {% if tournament.is_full %}
                                <span class="badge" style="background: rgba(255, 0, 0, 0.2); color: #ff6b6b;">Мест: {{ tournament.participants.count }}/{{ tournament.max_participants }}</span>
                                {% else %}
                                <span class="badge" style="background: var(--color-bg-elevated);">Мест: {{ tournament.participants.count }}/{{ tournament.max_participants }}</span>
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        <h3 class="card-title" style="margin: 0; color: var(--color-text);">
                            {{ tournament.name }}
                        </h3>
                        
                        <p class="card-text text-secondary" style="margin: 0;">
                            {{ tournament.start_date|date:"d.m.Y" }}{% if tournament.end_date %} — {{ tournament.end_date|date:"d.m.Y" }}{% endif %}
                        </p>
                        
                        <div style="display: flex; align-items: center; gap: var(--spacing-md); flex-wrap: wrap;">
                            <span class="player-category">{{ tournament.get_tournament_type_display }}</span>
                        </div>
                        
                        {% if tournament.participants.all %}
                        <div style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
                            <span class="text-secondary" style="font-size: var(--font-size-sm);">Участники:</span>
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: var(--spacing-xs);">
                                {% for participant in tournament.participants.all|slice:":10" %}
                                <div style="display: flex; align-items: center; gap: var(--spacing-xs); background: var(--color-bg-elevated); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-md); min-width: 0;">
                                    {% if participant.avatar %}
                                    <img src="{{ participant.avatar.url }}" alt="" class="player-avatar" style="width: 24px; height: 24px; flex-shrink: 0;">
                                    {% else %}
                                    <div class="player-avatar" style="width: 24px; height: 24px; flex-shrink: 0;"></div>
                                    {% endif %}
                                    <span style="font-size: var(--font-size-sm); font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ participant.user.first_name }} {{ participant.user.last_name }}</span>
                                </div>
                                {% endfor %}
                                {% if tournament.participants.count > 10 %}
                                <div style="display: flex; align-items: center; gap: var(--spacing-xs); background: var(--color-bg-elevated); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-md);">
                                    <span class="text-secondary" style="font-size: var(--font-size-sm); font-weight: 500;">+{{ tournament.participants.count|add:"-10" }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <span class="text-secondary" style="font-size: var(--font-size-sm);">Пока нет участников</span>
                        {% endif %}
                    </div>
                    
                    <div style="flex-shrink: 0; position: relative; z-index: 10;">
                        {% if user.is_authenticated %}
                            {% if tournament.is_full %}
                            <button class="btn btn-outline" disabled style="cursor: not-allowed; opacity: 0.5;">Мест нет</button>
                            {% else %}
                            <a href="{% url 'tournament_register' slug=tournament.slug %}" class="btn btn-primary" onclick="event.stopPropagation();">Записаться</a>
                            {% endif %}
                        {% else %}
                        <a href="{% url 'login' %}?next={% url 'home' %}" class="btn btn-outline" onclick="event.stopPropagation();">Войти</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-secondary">Подходящих турниров не найдено.</p>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Top Players -->
<section class="section" style="background: var(--color-bg-secondary);">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Топ рейтинга</h2>
            <a href="{% url 'rating' %}" class="btn btn-outline">Полный рейтинг</a>
        </div>

        <div class="grid">
            {% for player in top_players %}
            <a href="{% url 'profile' pk=player.pk %}" class="player-card">
                <span class="player-rank">{{ forloop.counter }}</span>
                {% if player.avatar %}
                <img src="{{ player.avatar.url }}" alt="" class="player-avatar">
                {% else %}
                <div class="player-avatar"></div>
                {% endif %}
                <div class="player-info">
                    <div class="player-name">{{ player }}</div>
                    <span class="player-category">{{ player.get_category_display }}</span>
                </div>
                <div class="player-stats">
                    <div>
                        <div class="stat-value">{{ player.matches_played }}</div>
                        <div class="stat-label">Матчей</div>
                    </div>
                    <div>
                        <div class="stat-value">{{ player.win_rate }}%</div>
                        <div class="stat-label">Побед</div>
                    </div>
                </div>
                <div class="player-points text-primary">{{ player.total_points }}</div>
            </a>
            {% empty %}
            <p class="text-secondary">Рейтинг пока не сформирован.</p>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Upcoming Tournaments -->
<section class="section">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Ближайшие турниры</h2>
            <a href="{% url 'tournament_list' %}" class="btn btn-outline">Все турниры</a>
        </div>

        <div class="grid grid-3">
            {% for tournament in upcoming_tournaments %}
            <a href="{% url 'tournament_detail' slug=tournament.slug %}" class="card">
                {% if tournament.image %}
                <img src="{{ tournament.image.url }}" alt="" class="card-image">
                {% endif %}
                <div class="card-body">
                    <span class="player-category mb-1">{{ tournament.get_category_display }}</span>
                    <h3 class="card-title">{{ tournament.name }}</h3>
                    <p class="card-text">
                        {{ tournament.get_city_display }} • {{ tournament.start_date|date:"d.m.Y" }}
                    </p>
                </div>
            </a>
            {% empty %}
            <p class="text-secondary">Нет предстоящих турниров.</p>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Latest News -->
{% if latest_news %}
<section class="section" style="background: var(--color-bg-secondary);">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Новости</h2>
            <a href="{% url 'news_list' %}" class="btn btn-outline">Все новости</a>
        </div>

        <div class="grid grid-4">
            {% for news in latest_news %}
            <a href="{% url 'news_detail' slug=news.slug %}" class="card">
                {% if news.image %}
                <img src="{{ news.image.url }}" alt="" class="card-image">
                {% endif %}
                <div class="card-body">
                    <h3 class="card-title">{{ news.title }}</h3>
                    <p class="card-text">{{ news.excerpt|truncatewords:15 }}</p>
                    <p class="text-muted mt-2" style="font-size: var(--font-size-xs);">
                        {{ news.created_at|date:"d.m.Y" }}
                    </p>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}
{% endblock %}