{% extends 'base.html' %}

{% block title %}Рейтинг игроков{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Рейтинг игроков</h1>
    <p class="page-subtitle">Топ игроков по количеству очков за текущий сезон</p>
</div>

<div class="container">
    <!-- Filters -->
    <form method="get" class="filter-bar">
        <input name="city" class="form-control" placeholder="Любой город России" value="{{ current_city }}">
        <select name="skill_level" class="form-control" onchange="this.form.submit()">
            <option value="">Все уровни</option>
            {% for value, label in skill_level_choices %}
            <option value="{{ value }}" {% if current_skill_level == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
        <input type="text" name="q" value="{{ search_query }}" placeholder="Поиск по имени..." class="form-control">
        <button type="submit" class="btn btn-primary">Поиск</button>
    </form>

    <div class="rating-toggle">
        <button type="button" class="btn btn-outline" id="rating-toggle-btn">Показать в виде диаграммы</button>
    </div>


    <!-- Players List -->
    <div class="rating-list" id="rating-list">
        <div class="grid">
        {% for player in players %}
        <a href="{% url 'profile' pk=player.pk %}" class="player-card">
            <span class="player-rank">{{ forloop.counter }}</span>
            {% if player.avatar %}
            <img src="{{ player.avatar.url }}" alt="" class="player-avatar">
            {% else %}
            <div class="player-avatar"></div>
            {% endif %}
            <div class="player-info">
                <div class="player-name" style="display:flex;align-items:center;gap:8px;">
                    <span>{{ player }}</span>
                    {% with tier=player.active_subscription_tier %}
                        {% if tier and tier.has_badge %}
                            <img src="/static/images/{{ tier.name }}.png" alt="{{ tier.name }}" title="{{ tier.get_name_display }}" style="width: 16px; height: 16px;">
                        {% endif %}
                    {% endwith %}
                    {% if not player.is_verified %}
                    <span class="badge" style="background: var(--color-warning, #ffd24d); color: #000;">Неверифицирован</span>
                    {% endif %}
                </div>
                <span class="player-category">{{ player.get_skill_level_display }}</span>
            </div>
            <div class="player-stats">
                <div>
                    <div class="stat-value">{{ player.matches_played }}</div>
                    <div class="stat-label">Матчей</div>
                </div>
                <div>
                    <div class="stat-value">{{ player.matches_won }}</div>
                    <div class="stat-label">Побед</div>
                </div>
                <div>
                    <div class="stat-value">{{ player.win_rate }}%</div>
                    <div class="stat-label">% побед</div>
                </div>
            </div>
            <div class="player-points">
                <span class="text-muted" style="font-size: var(--font-size-xs);">ОЧКИ</span><br>
                <span class="text-primary">{{ player.total_points }}</span>
            </div>
        </a>
        {% empty %}
        <p class="text-secondary text-center">Игроки не найдены.</p>
        {% endfor %}
        </div>
    </div>

    <div class="rating-chart hidden" id="rating-chart">
        <div class="card">
            <div class="card-body">
                <h2 class="section-title">Рейтинг в виде диаграммы</h2>
                <div id="rating-chart-bars" class="rating-chart-bars"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const ratingData = [
        {% for player in players %}
        { name: "{{ player|escapejs }}", points: {{ player.total_points|default:0 }} },
        {% endfor %}
    ];

    const ratingToggleBtn = document.getElementById('rating-toggle-btn');
    const ratingList = document.getElementById('rating-list');
    const ratingChart = document.getElementById('rating-chart');
    const ratingChartBars = document.getElementById('rating-chart-bars');

    const renderChart = () => {
        ratingChartBars.innerHTML = '';
        if (!ratingData.length) {
            ratingChartBars.innerHTML = '<p class="text-secondary">Игроки не найдены.</p>';
            return;
        }

        const maxPoints = Math.max(...ratingData.map(item => item.points));
        ratingData.forEach((item, index) => {
            const row = document.createElement('div');
            row.className = 'rating-chart-row';
            const width = maxPoints > 0 ? (item.points / maxPoints) * 100 : 0;
            row.innerHTML = `
                <div class="rating-chart-label">${index + 1}. ${item.name}</div>
                <div class="rating-chart-bar">
                    <span style="width:${width}%;"></span>
                </div>
                <div class="rating-chart-value">${item.points}</div>
            `;
            ratingChartBars.appendChild(row);
        });
    };

    if (ratingToggleBtn) {
        ratingToggleBtn.addEventListener('click', () => {
            const isHidden = ratingChart.classList.contains('hidden');
            ratingChart.classList.toggle('hidden');
            ratingList.classList.toggle('hidden');
            if (isHidden) {
                renderChart();
                ratingToggleBtn.textContent = 'Показать списком';
            } else {
                ratingToggleBtn.textContent = 'Показать в виде диаграммы';
            }
        });
    }
</script>
{% endblock %}