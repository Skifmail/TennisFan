<h2>FAN — одноэтапная сетка на выбывание. Аналог Олимпийской системы в формате выбывания, но с наличием подвала.</h2>

<p>FAN (Fair Amateur Network) — формат турнира с одноэтапной сеткой на выбывание (single elimination). Турнир проводится при любом количестве участников от 2 до максимума, заданного организатором (например, 16 или 32).</p>

<h3>1. Ключевые особенности</h3>
<ul>
    <li><strong>Посев по рейтингу</strong> — сильнейшие игроки не встречаются в первом круге.</li>
    <li><strong>Очки начисляются при вылете</strong> — чем дальше прошёл игрок, тем больше очков он получает.</li>
    <li><strong>Подвал</strong> — проигравшие в первом круге играют дополнительную сетку, все участники проводят минимум 2 матча.</li>
    <li><strong>Свободный круг (bye)</strong> — при нечётном числе участников используется служебный игрок «Свободный круг».</li>
</ul>

<hr>

<h3>2. Регистрация и формирование сетки</h3>

<h4>2.1. Регистрация</h4>
<p>Участники регистрируются на турнир до дедлайна регистрации. Организатор задаёт максимальное количество участников (обязательно для FAN).</p>

<h4>2.2. Когда формируется сетка</h4>
<p>Сетка формируется автоматически после истечения дедлайна регистрации. В этот момент:</p>
<ul>
    <li>Список участников фиксируется.</li>
    <li>Регистрация закрывается.</li>
    <li>Система создаёт матчи первого круга.</li>
</ul>

<h4>2.3. Условия формирования</h4>
<ul>
    <li>Минимум 2 участника.</li>
    <li>Количество участников не должно превышать максимум турнира.</li>
    <li>При нечётном числе участников в системе должен быть служебный игрок «Свободный круг».</li>
</ul>

<hr>

<h3>3. Посев и пары первого круга</h3>

<h4>3.1. Сортировка</h4>
<p>Участники сортируются по рейтингу (<code>total_points</code>) от большего к меньшему. Нумерация: 1-й — сильнейший, 2-й — второй по силе, и т.д.</p>

<h4>3.2. Правило формирования пар</h4>
<ul>
    <li>1-й сеяный играет с последним (N-м).</li>
    <li>2-й — с предпоследним (N-1).</li>
    <li>3-й — с (N-2).</li>
    <li>И так далее.</li>
</ul>

<h4>3.3. Пример для 8 участников</h4>
<ul>
    <li>Матч 1: 1 vs 8</li>
    <li>Матч 2: 2 vs 7</li>
    <li>Матч 3: 3 vs 6</li>
    <li>Матч 4: 4 vs 5</li>
</ul>
<p>Таким образом сильнейшие не встречаются в первом круге.</p>

<hr>

<h3>4. Нечётное количество участников — первый круг</h3>

<p>Если участников нечётное число (например, 9, 11, 15), одному игроку не хватает пары. В этом случае используется служебный игрок «Свободный круг» (bye).</p>

<h4>4.1. Правило</h4>
<p><strong>Свободный круг получает сильнейший (1-й сеяный).</strong></p>
<ul>
    <li>Создаётся матч «1-й сеяный vs Свободный круг».</li>
    <li>Матч сразу считается завершённым (walkover) — 1-й сеяный побеждает.</li>
    <li>Игрок автоматически выходит во второй круг без игры.</li>
</ul>

<h4>4.2. Пример для 9 участников</h4>
<ul>
    <li>Матч 1: 1 vs Свободный круг (автопобеда 1-го)</li>
    <li>Матч 2: 2 vs 9</li>
    <li>Матч 3: 3 vs 8</li>
    <li>Матч 4: 4 vs 7</li>
    <li>Матч 5: 5 vs 6</li>
</ul>
<p>Итого: 5 матчей, 5 победителей выходят во второй круг.</p>

<hr>

<h3>5. Продвижение победителей — второй круг и далее</h3>

<h4>5.1. Общий принцип</h4>
<p>После завершения матча победитель переходит в следующий раунд. Когда оба «фидерных» матча (чьи победители должны встретиться) завершены, создаётся новый матч следующего раунда.</p>

<h4>5.2. Структура продвижения</h4>
<ul>
    <li>Победители матчей 1 и 2 → матч 2-го круга №1</li>
    <li>Победители матчей 3 и 4 → матч 2-го круга №2</li>
    <li>И так далее.</li>
</ul>

<h4>5.3. Названия раундов</h4>
<ul>
    <li>Раунд 1: 1 круг</li>
    <li>Раунд 2: 2 круг</li>
    <li>Раунд 3: Полуфинал</li>
    <li>Раунд 4: Финал</li>
</ul>

<hr>

<h3>6. Нечётное число победителей — второй круг и полуфинал</h3>

<p>Если в раунде нечётное число победителей (например, 5 вышли из 1-го круга), одному не хватает пары для следующего раунда.</p>

<h4>6.1. Правило</h4>
<p><strong>Свободный круг получает сильнейший по рейтингу среди победителей этого раунда.</strong></p>
<ul>
    <li>Система находит игрока с максимальным рейтингом среди всех победителей раунда.</li>
    <li>Создаётся матч «этот игрок vs Свободный круг» (walkover).</li>
    <li>Игрок автоматически выходит в следующий раунд.</li>
    <li>Остальные победители играют между собой в обычных матчах.</li>
</ul>

<h4>6.2. Важно: своп при каскадном создании</h4>
<p>Если матч следующего раунда уже создан (например, победители матчей 1 и 2 сыграли раньше), а «сирота» (игрок без пары) — не сильнейший по рейтингу, система выполняет своп: сирота занимает место сильнейшего в уже созданном матче, а сильнейший получает bye в новый матч. Это обеспечивает справедливость — bye всегда получает сильнейший.</p>

<h4>6.3. Финал — никогда не содержит Bye</h4>
<p>Финал всегда играют два победителя полуфиналов. При каскадном создании матчей система ждёт второй полуфинал. В финале не может быть матча с участием Свободного круга.</p>

<h4>6.4. Пример: 10 участников</h4>
<ul>
    <li>R1: 5 матчей → 5 победителей. Один (сильнейший) получает bye во 2-й круг.</li>
    <li>R2: 2 матча + 1 bye → 3 человека в полуфинал.</li>
    <li>Полуфинал: 1 матч + 1 bye → 2 человека в финал.</li>
    <li>Финал: 1 матч между двумя реальными игроками.</li>
</ul>

<hr>

<h3>7. Подвал</h3>

<p>Чтобы проигравшие в первом круге не вылетали после одного матча, для них создаётся «подвал» — дополнительная сетка.</p>

<h4>7.1. Когда создаётся подвал</h4>
<p>Подвал создаётся автоматически после завершения <strong>всех</strong> матчей 1-го круга основной сетки.</p>

<h4>7.2. Участники подвала</h4>
<p>Все проигравшие в R1 (кроме «Свободного круга», если он был в паре). Проигравшие сортируются по порядку матчей (round_order) в R1.</p>

<h4>7.3. Пары подвала</h4>
<ul>
    <li>1-й проигравший vs последний</li>
    <li>2-й vs предпоследний</li>
    <li>3-й vs (N-3)</li>
    <li>И так далее.</li>
</ul>

<h4>7.4. Нечётное число проигравших</h4>
<p>При нечётном числе проигравших (например, 5):</p>
<ul>
    <li>4 играют в 2 матчах.</li>
    <li>5-му (среднему по порядку) даётся матч vs Свободный круг (walkover).</li>
    <li>В итоге все проигравшие R1 сыграли минимум 2 матча.</li>
</ul>

<h4>7.5. Очки за подвал</h4>
<p>Проигравшие в подвале получают очки как за вылет в 1-м круге основной сетки (по умолчанию 10 очков). Они уже вылетели в R1, подвал — дополнительная игра для того, чтобы все сыграли минимум 2 матча.</p>

<h4>7.6. Структура подвала</h4>
<p>Подвал состоит из одного круга. Победители подвала не продвигаются дальше — подвал не имеет своей финальной стадии. Цель подвала — дать проигравшим в R1 ещё один матч.</p>

<hr>

<h3>8. Система очков</h3>

<h4>8.1. Когда начисляются очки</h4>
<p>Очки начисляются при вылете или при достижении финала/победы. Чем дальше прошёл игрок — тем больше очков.</p>

<h4>8.2. Значения по умолчанию (настраиваются в турнире)</h4>
<ul>
    <li>Вылет в 1-м круге основной сетки: 10 очков</li>
    <li>Вылет во 2-м круге: 25 очков</li>
    <li>Вылет в полуфинале: 45 очков</li>
    <li>Финалист (проиграл в финале): 70 очков</li>
    <li>Победитель турнира: 100 очков</li>
</ul>

<h4>8.3. Момент начисления</h4>
<ul>
    <li><strong>При вылете</strong> — сразу после завершения матча, в котором игрок проиграл (создаётся/обновляется запись TournamentPlayerResult).</li>
    <li><strong>Финалист и победитель</strong> — после завершения финального матча.</li>
</ul>

<h4>8.4. Зачисление в рейтинг</h4>
<p>Очки добавляются к общему рейтингу игрока (<code>total_points</code>) только после полного завершения турнира — когда сыгран финал. До этого очки хранятся в TournamentPlayerResult.</p>

<hr>

<h3>9. Дедлайн матча и просрочка</h3>

<h4>9.1. Дедлайн</h4>
<p>У каждого матча есть дедлайн (по умолчанию 7 дней на раунд — параметр <code>match_days_per_round</code>). Дедлайн рассчитывается от даты старта турнира: для раунда N — start_date + N × days_per_round.</p>

<h4>9.2. Если матч не сыгран к дедлайну</h4>
<ul>
    <li>Победа присуждается игроку с более высоким рейтингом.</li>
    <li>При равенстве рейтинга — игроку с меньшим id (первый зарегистрированный в системе).</li>
    <li>Матч оформляется как тех. победа (walkover).</li>
    <li>Игроки получают уведомления о технической победе/поражении.</li>
    <li>Победитель продвигается дальше, проигравший получает очки за вылет.</li>
    <li>Создаётся следующий матч (если оба фидера готовы), подвал (если это R1), финализация (если это финал).</li>
</ul>

<h4>9.3. Обработка просроченных матчей</h4>
<p>Выполняется автоматически по расписанию (cron) или вручную через админ-панель. При обработке просроченного матча система последовательно: присуждает победу, продвигает победителя, создаёт подвал (если R1), вызывает финализацию турнира.</p>

<hr>

<h3>10. Завершение турнира</h3>

<h4>10.1. Условие завершения</h4>
<p>Турнир считается завершённым, когда сыгран финальный матч (между двумя реальными игроками, без Свободного круга).</p>

<h4>10.2. Что происходит при завершении</h4>
<ul>
    <li>Финалисту и победителю начисляются очки (70 и 100 по умолчанию).</li>
    <li>Все накопленные очки участников (за вылет в своём раунде) добавляются к их общему рейтингу (<code>total_points</code>).</li>
    <li>Статус турнира меняется на «Завершён».</li>
</ul>

<hr>

<h3>11. Подтверждение результата матча</h3>

<p>В FAN-турнирах результат матча может быть предложен одним из игроков и должен быть подтверждён соперником (или админом). После подтверждения:</p>
<ul>
    <li>Победитель продвигается в следующий раунд.</li>
    <li>Проигравшему начисляются очки за вылет.</li>
    <li>При необходимости создаётся матч следующего раунда.</li>
    <li>Если это R1 — проверяется создание подвала.</li>
    <li>Вызывается финализация (если финал сыгран).</li>
</ul>

<hr>

<h3>12. Структура раундов — примеры</h3>

<ul>
    <li><strong>8 участников:</strong> R1 (4 матча) → R2 (2 матча) → Финал (1 матч)</li>
    <li><strong>10 участников:</strong> R1 (5 матчей) → R2 (2 + bye) → Полуфинал (1 + bye) → Финал</li>
    <li><strong>16 участников:</strong> R1 (8 матчей) → R2 (4) → Полуфинал (2) → Финал (1)</li>
</ul>

<p>Количество раундов до финала: ceil(log₂(N)). Например, для 10 участников нужно 4 раунда (R1, R2, Полуфинал, Финал).</p>

<hr>

<h3>13. Служебный игрок «Свободный круг»</h3>

<p>Свободный круг (bye) — служебный игрок, используемый при нечётном числе участников или победителей. Идентификация: email <code>bye@tennisfan.local</code>, поле <code>is_bye=True</code>.</p>

<hr>

<h3>14. Парные турниры (FAN)</h3>

<p>Формат FAN поддерживает парные турниры — команды по 2 человека (2 на 2). Регистрация, формирование сетки, начисление очков и подвал работают аналогично, но участниками являются команды. Очки начисляются обоим игрокам команды. Подробное описание — во вкладке <strong>«Парные турниры»</strong>.</p>
