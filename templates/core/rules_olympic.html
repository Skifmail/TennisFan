<h2>Олимпийская система с матчами за все места (утешительная сетка)</h2>

<p>Формат «Олимпийская система (утешительная сетка)» — это турнир на выбывание, в котором <strong>каждое место определяется матчем</strong>: 1–2 в финале основной сетки, 3–4 в матче проигравших полуфиналистов, 5–8 (и далее) — в отдельных утешительных сетках. Проигравший в раунде основной сетки не выбывает из турнира, а переходит в утешительную сетку за соответствующий диапазон мест.</p>

<h3>1. Ключевые особенности</h3>
<ul>
    <li><strong>Основная сетка</strong> — как в FAN: одноэтапное выбывание, посев по рейтингу, при нечётном N — «Свободный круг» (BYE).</li>
    <li><strong>Утешительные сетки</strong> — проигравшие в одном раунде основной сетки образуют мини-сетку за конкретные места (например, места 5–8).</li>
    <li><strong>Место определяется только матчем</strong> — 1–2, 3–4, 5–6, 7–8 и т.д. решаются игрой, а не по таблице.</li>
    <li><strong>Очки по итоговому месту</strong> — начисляются после определения места (в момент последнего матча участника в основной или утешительной сетке).</li>
    <li><strong>Одиночные и парные</strong> — формат поддерживает оба варианта; в парных участвуют команды.</li>
</ul>

<hr>

<h3>2. Регистрация и формирование основной сетки</h3>

<h4>2.1. Регистрация</h4>
<p>Участники (или команды в парном турнире) регистрируются до дедлайна регистрации. Организатор задаёт максимальное количество участников или команд (обязательно).</p>

<h4>2.2. Когда формируется сетка</h4>
<p>Основная сетка формируется автоматически после истечения дедлайна регистрации (при загрузке страницы турниров или по расписанию). Организатор может сформировать сетку вручную в админ-панели (действие «Сформировать сетку (олимпийская)»). В момент формирования:</p>
<ul>
    <li>Список участников (команд) фиксируется.</li>
    <li>Регистрация закрывается.</li>
    <li>Система создаёт только матчи первого круга основной сетки. Утешительные сетки создаются позже — по мере завершения раундов.</li>
</ul>

<h4>2.3. Условия формирования</h4>
<ul>
    <li>Минимум 2 участника (или 2 команды в парном турнире).</li>
    <li>Количество не должно превышать максимум турнира.</li>
    <li>При нечётном числе в системе должен быть служебный игрок «Свободный круг» (для одиночных) или команда BYE (для парных).</li>
</ul>

<h4>2.4. Посев и пары первого круга</h4>
<p>Участники сортируются по рейтингу (<code>total_points</code>; для парных — по суммарному рейтингу команды или рейтингу первого игрока) от большего к меньшему. Пары первого круга: 1-й с последним (N-м), 2-й с (N−1)-м и т.д. При нечётном N сильнейший (1-й сеяный) получает матч с «Свободным кругом» — тех. победа и выход во второй круг без игры.</p>

<hr>

<h3>3. Продвижение в основной сетке</h3>

<h4>3.1. Общий принцип</h4>
<p>После завершения матча основной сетки победитель переходит в следующий раунд. Когда оба «фидерных» матча (чьи победители должны встретиться) завершены, создаётся матч следующего раунда. Структура раундов: 1 круг → 2 круг → Полуфинал → Финал (для 8 участников: 4 → 2 → 1 матч).</p>

<h4>3.2. Проигравший в основной сетке</h4>
<p>Проигравший не выбывает из турнира. Он попадает в утешительную сетку своего раунда — но эта сетка создаётся только после того, как <strong>все</strong> матчи данного раунда основной сетки завершены (см. раздел 4). Игрок, прошедший по BYE и затем проигравший в следующем раунде, участвует в утешительной сетке этого раунда. Сам BYE в утешительных матчах не участвует.</p>

<hr>

<h3>4. Диапазоны мест и создание утешительных сеток</h3>

<h4>4.1. Какие места за какой раунд</h4>
<p>Проигравшие в раунде основной сетки борются за строго определённый диапазон мест:</p>
<ul>
    <li><strong>Проигравшие в 1-м круге</strong> — места 5–8 (при 8 участниках), 9–16 (при 16), 17–32 (при 32) и т.д.</li>
    <li><strong>Проигравшие в полуфинале</strong> (2 человека) — места 3–4.</li>
    <li><strong>Финал основной сетки</strong> — места 1–2 (победитель — 1-е, проигравший — 2-е). Отдельной «утешительной» сетки за 1–2 нет.</li>
</ul>

<h4>4.2. Когда создаётся утешительная сетка</h4>
<p>Утешительная сетка за места данного раунда создаётся <strong>один раз</strong>, после того как завершены <strong>все</strong> матчи этого раунда основной сетки. Например, при 8 участниках в 1-м круге 4 матча; как только все 4 сыграны (или засчитаны тех. победой), система собирает четырёх проигравших и создаёт утешительную сетку за места 5–8.</p>

<h4>4.3. Структура утешительной сетки для 2 проигравших (места 3–4)</h4>
<p>Создаётся один матч. Победитель получает 3-е место, проигравший — 4-е. Оба места фиксируются после завершения этого матча.</p>

<h4>4.4. Структура утешительной сетки для 4 проигравших (места 5–8)</h4>
<p>Четыре проигравших 1-го круга образуют мини-олимпийскую сетку:</p>
<ul>
    <li>Два полуфинала: пары формируются по порядку проигрыша в основной сетке (1-й проигравший с 4-м, 2-й с 3-м).</li>
    <li>Победители полуфиналов играют матч за 5–6 места (победитель — 5-е, проигравший — 6-е).</li>
    <li>Проигравшие полуфиналов играют матч за 7–8 места (победитель — 7-е, проигравший — 8-е).</li>
</ul>
<p>Таким образом, все четыре участника получают место только после завершения своих матчей в утешительной сетке.</p>

<h4>4.5. Большее число участников</h4>
<p>При 16 участниках проигравшие 1-го круга (8 человек) образуют утешительную сетку за места 9–16 по тому же принципу: мини-сетка на выбывание с матчами за 9–10, 11–12, 13–14, 15–16. Логика всегда одна: степень двойки проигравших → полноценная утешительная сетка с матчами за каждые два места.</p>

<h4>4.6. Нечётное число проигравших</h4>
<p>Если в раунде основной сетки был BYE, проигравших может быть на одного меньше (например, 3 вместо 4). В этом случае одному участнику место присваивается без матча (например, 8-е место при сетке за 5–8 и трёх проигравших), либо система создаёт схему с одним «свободным» местом по правилам, заданным организатором. В текущей реализации при 2 проигравших — один матч за 3–4; при 4 — полная сетка за 5–8.</p>

<hr>

<h3>5. Начисление очков</h3>

<h4>5.1. Привязка к месту</h4>
<p>Очки начисляются по итоговому занятому месту. Используются те же настройки турнира, что и в формате FAN:</p>
<ul>
    <li>1-е место — очки победителю (по умолчанию 100).</li>
    <li>2-е место — очки финалисту (70).</li>
    <li>3–4 места — очки за полуфинал (45).</li>
    <li>5–8 места — очки за 2 круг (25).</li>
    <li>9–16 и далее — очки за 1 круг (10).</li>
</ul>

<h4>5.2. Момент фиксации места и очков</h4>
<p>Место фиксируется в момент завершения последнего матча участника, в котором определяется его итоговое место: в финале основной сетки (1–2), в матче за 3–4, в финале или в матче за 7–8 утешительной сетки и т.д. Одновременно в запись результата турнира (TournamentPlayerResult) заносится место и соответствующие очки. Очки в общий рейтинг (<code>total_points</code>) добавляются только после полного завершения турнира (см. п. 6).</p>

<h4>5.3. Парные турниры</h4>
<p>Очки начисляются обоим игрокам команды одинаково: за занятое место команды оба получают одни и те же очки (как в FAN по месту вылета).</p>

<hr>

<h3>6. Завершение турнира</h3>

<p>Турнир считается завершённым, когда сыгран финал основной сетки и определены все места (все участники получили итоговое место в своей последней игре). После этого:</p>
<ul>
    <li>Всем участникам по их месту начисляются очки (согласно п. 5).</li>
    <li>Очки добавляются к общему рейтингу (<code>total_points</code>).</li>
    <li>Статус турнира меняется на «Завершён».</li>
</ul>

<hr>

<h3>7. Дедлайны матчей и техническая победа</h3>

<h4>7.1. Дедлайн</h4>
<p>У каждого матча есть дедлайн (по умолчанию задаётся «дней на раунд» в настройках турнира). Дедлайн считается от даты старта турнира и номера раунда.</p>

<h4>7.2. Просрочка матча</h4>
<p>Если матч не сыгран к дедлайну:</p>
<ul>
    <li>Победа присуждается игроку (команде) с более высоким рейтингом; при равенстве — с меньшим id в системе.</li>
    <li>Матч оформляется как тех. победа (walkover).</li>
    <li>Система продвигает победителя, при необходимости создаёт следующий матч основной сетки и, если весь раунд основной сетки завершён, — утешительную сетку этого раунда.</li>
    <li>Обработка просроченных матчей выполняется автоматически по расписанию (cron) или вручную через админ-панель (команда <code>olympic_process_overdue_matches</code>).</li>
</ul>

<hr>

<h3>8. Подтверждение результата матча</h3>

<p>Как и в FAN, результат матча может предложить один из участников; второй (или организатор) подтверждает или отклоняет. После подтверждения:</p>
<ul>
    <li>В основной сетке: победитель продвигается в следующий матч; при завершении всех матчей раунда создаётся утешительная сетка за места этого раунда.</li>
    <li>В утешительной сетке: победитель переходит в следующий матч (например, в финал за 5–6), проигравший — в матч за следующее место (например, за 7–8). Если матч решает два места (5–6 или 7–8), обоим присваиваются места и очки.</li>
    <li>При необходимости проверяется завершение турнира и начисление очков в рейтинг.</li>
</ul>

<hr>

<h3>9. Одиночные и парные турниры</h3>

<p>Формат поддерживает оба варианта. В парных турнирах:</p>
<ul>
    <li>Регистрация и формирование команд — как описано в разделе «Парные турниры» (solo, с партнёром, присоединение к команде).</li>
    <li>В основной и утешительной сетках участвуют команды (два игрока). Продвижение и места — у команды; очки начисляются обоим игрокам команды.</li>
    <li>Свободный круг (BYE) для парных реализуется как команда из служебного игрока; в утешительных матчах BYE не участвует.</li>
</ul>

<hr>

<h3>10. Визуализация и турнирная таблица</h3>

<ul>
    <li><strong>Страница турнира</strong> — отображаются основная сетка и утешительные сетки. Раунды утешительных подписаны диапазоном мест (например, «Места 5–8», «Места 3–4»).</li>
    <li><strong>Турнирная таблица</strong> — участники отсортированы по занятому месту (1, 2, 3, …). Отображаются место, участник (или команда), начисленные очки.</li>
    <li><strong>Активные матчи</strong> — на сайте видны матчи, которые нужно сыграть; по раунду и подписи видно, за какие места идёт борьба.</li>
</ul>

<hr>

<h3>11. Краткая сводка</h3>

<p>Основная сетка формируется после дедлайна регистрации (или вручную), по рейтингу, с BYE при нечётном N. Проигравшие каждого раунда основной сетки после завершения всего раунда образуют утешительную сетку за места (5–8, 3–4 и т.д.). Каждое место определяется матчем. Очки начисляются по месту; в рейтинг очки добавляются после полного завершения турнира.</p>
