{% extends 'base.html' %}
{% load static %}

{% block title %}Спарринг{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Спарринг</h1>
    <p class="page-subtitle">Найдите партнёра для игры</p>
</div>

<div class="container">
    <div class="sparring-toolbar d-flex flex-wrap gap-2 mb-4">
        <form method="get" class="filter-bar sparring-filters">
            <input name="city" class="form-control" placeholder="Любой город России" value="{{ current_city }}" onchange="this.form.submit()">
            <select name="category" class="form-control" onchange="this.form.submit()">
                <option value="">Все уровни (NTRP)</option>
                <option value="novice" {% if current_category == 'novice' %}selected{% endif %}>Новичок</option>
                <option value="amateur" {% if current_category == 'amateur' %}selected{% endif %}>Любитель</option>
                <option value="experienced" {% if current_category == 'experienced' %}selected{% endif %}>Опытный</option>
                <option value="advanced" {% if current_category == 'advanced' %}selected{% endif %}>Продвинутый</option>
                <option value="professional" {% if current_category == 'professional' %}selected{% endif %}>Профессионал</option>
            </select>
        </form>
        <div class="sparring-toolbar__actions">
            <a href="{% url 'sparring_my_requests' %}" class="btn btn-ghost">Мои заявки</a>
            {% if has_sparring_access %}
            <a href="{% url 'sparring_create' %}" class="btn btn-primary">Создать заявку</a>
            {% else %}
            <a href="{% url 'pricing' %}" class="btn btn-outline">Подписка для доступа</a>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-2">
        {% for req in sparring_requests %}
        <div class="card sparring-card">
            <div class="card-body">
                <div class="sparring-card__flags">
                    <span class="sparring-flag sparring-flag--recruiting">Идёт набор</span>
                    {% if req.has_responses %}
                    <span class="sparring-flag sparring-flag--responses">Есть отклики</span>
                    {% endif %}
                </div>
                <div class="d-flex gap-3 sparring-card__main" style="align-items: flex-start;">
                    {% if req.player.avatar %}
                    <img src="{{ req.player.avatar.url }}" alt="" class="player-avatar sparring-card__avatar">
                    {% else %}
                    <div class="player-avatar sparring-card__avatar"></div>
                    {% endif %}
                    <div class="sparring-card__content">
                        <div class="player-name-block">
                            <a href="{% url 'profile' pk=req.player.pk %}" class="player-name">{{ req.player }}</a>
                            {% include 'includes/subscription_badge.html' with tier=req.player.paid_subscription_tier %}
                        </div>
                        <div class="d-flex gap-1 mt-1 mb-2 flex-wrap">
                            <span class="player-category">{{ req.player.get_skill_level_display }}</span>
                            {% if req.desired_category %}
                            <span class="sparring-desired-category">Партнёр: {{ req.get_desired_category_display }}</span>
                            {% endif %}
                            <span class="player-category" style="background: var(--color-bg-elevated); color: var(--color-text-secondary);">{{ req.city }}</span>
                        </div>
                        <p class="text-secondary sparring-card__desc">{{ req.description }}</p>
                        {% if req.preferred_days or req.preferred_time %}
                        <p class="text-muted mt-2" style="font-size: var(--font-size-xs);">
                            {% if req.preferred_days %}{{ req.preferred_days }}{% endif %}
                            {% if req.preferred_time %} • {{ req.preferred_time }}{% endif %}
                        </p>
                        {% endif %}
                    </div>
                </div>
                <div class="sparring-card__actions mt-3">
                    {% if user.is_authenticated and user.player.pk == req.player_id %}
                    <a href="{% url 'sparring_edit' req.pk %}" class="btn btn-outline">Редактировать</a>
                    <a href="{% url 'sparring_my_requests' %}" class="btn btn-ghost">Мои заявки</a>
                    {% elif has_sparring_access %}
                        {% if req.player.telegram or req.player.whatsapp or req.player.max_url %}
                    <button type="button" class="btn btn-primary sparring-respond-btn" data-id="{{ req.pk }}"
                            data-has-telegram="{% if req.player.telegram %}1{% else %}0{% endif %}"
                            data-has-whatsapp="{% if req.player.whatsapp %}1{% else %}0{% endif %}"
                            data-has-max="{% if req.player.max_url %}1{% else %}0{% endif %}">
                        Откликнуться
                    </button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <p class="text-secondary" style="grid-column: 1 / -1;">
            Заявок на спарринг пока нет.
            {% if has_sparring_access %}<a href="{% url 'sparring_create' %}" class="text-primary">Создайте первую!</a>{% else %}<a href="{% url 'pricing' %}" class="text-primary">Оформите подписку</a>, чтобы создавать заявки.{% endif %}
        </p>
        {% endfor %}
    </div>
</div>

<div class="sparring-modal hidden" id="sparring-respond-modal" role="dialog" aria-label="Выберите способ связи">
    <div class="sparring-modal__backdrop" id="sparring-modal-backdrop"></div>
    <div class="sparring-modal__box">
        <h3 class="sparring-modal__title">Связаться с автором заявки</h3>
        <p class="text-secondary sparring-modal__sub">Выберите способ связи:</p>
        <div class="sparring-modal__buttons">
            <a href="#" class="btn sparring-modal__link sparring-modal__link--tg messenger-btn" data-method="telegram" target="_blank" rel="noopener">
                <img src="{% static 'images/Telegram_logo.svg' %}" alt="" class="messenger-btn__icon" width="20" height="20"> Telegram
            </a>
            <a href="#" class="btn sparring-modal__link sparring-modal__link--wa messenger-btn" data-method="whatsapp" target="_blank" rel="noopener">
                <img src="{% static 'images/WhatsApp.svg' %}" alt="" class="messenger-btn__icon" width="20" height="20"> WhatsApp
            </a>
            <a href="#" class="btn sparring-modal__link sparring-modal__link--max messenger-btn" data-method="max">
                <img src="{% static 'images/Max_logo_2025.png' %}" alt="" class="messenger-btn__icon" width="20" height="20"> MAX
            </a>
        </div>
        <button type="button" class="btn btn-ghost sparring-modal__close" id="sparring-modal-close">Закрыть</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const modal = document.getElementById('sparring-respond-modal');
    const backdrop = document.getElementById('sparring-modal-backdrop');
    const closeBtn = document.getElementById('sparring-modal-close');
    const respondBtns = document.querySelectorAll('.sparring-respond-btn');
    const baseUrl = '{% url "sparring_list" %}'.replace(/\/$/, '');
    const prefix = baseUrl.replace(/\/sparring\/?$/, '') || '';
    let currentId = null;

    function respondUrl(id, method) {
        return prefix + '/sparring/' + id + '/respond/?method=' + method;
    }

    function openModal(id, hasTg, hasWa, hasMax) {
        currentId = id;
        var tg = modal.querySelector('.sparring-modal__link--tg');
        var wa = modal.querySelector('.sparring-modal__link--wa');
        var mx = modal.querySelector('.sparring-modal__link--max');
        tg.href = respondUrl(id, 'telegram');
        tg.style.display = hasTg === '1' ? '' : 'none';
        wa.href = respondUrl(id, 'whatsapp');
        wa.style.display = hasWa === '1' ? '' : 'none';
        mx.href = respondUrl(id, 'max');
        mx.style.display = (hasMax === '1' ? '' : 'none');
        modal.classList.remove('hidden');
    }

    function closeModal() {
        modal.classList.add('hidden');
        currentId = null;
    }

    respondBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
            openModal(this.dataset.id, this.dataset.hasTelegram || '0', this.dataset.hasWhatsapp || '0', this.dataset.hasMax || '0');
        });
    });

    modal.querySelectorAll('.sparring-modal__link').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            var method = this.dataset.method;
            if (!currentId) return;
            var url = respondUrl(currentId, method);
            if (method === 'max') {
                window.location.href = url;
            } else {
                window.open(url, '_blank', 'noopener');
            }
            closeModal();
        });
    });

    if (backdrop) backdrop.addEventListener('click', closeModal);
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
})();
</script>
{% endblock %}
