{% extends 'base.html' %}

{% block title %}Матч: {{ match.get_player1_display }} vs {{ match.get_player2_display }}{% endblock %}

{% block content %}
<div class="container" style="padding-top: var(--spacing-2xl);">
    <div class="mb-4">
        <a href="{% url 'tournament_detail' slug=match.tournament.slug %}" class="text-secondary">&larr; {{ match.tournament.name }}</a>
    </div>

    <div class="card" style="max-width: 700px; margin: 0 auto;">
        <div class="card-body" style="padding: var(--spacing-2xl);">
            <div class="text-center mb-4">
                <span class="player-category">{{ match.tournament.get_category_display }}{% if match.round_name %} · {{ match.round_name }}{% endif %}</span>
                <p class="text-muted mt-2">
                    {% if match.deadline %}Дедлайн: {{ match.deadline|date:"d.m.Y" }}{% elif match.scheduled_datetime %}{{ match.scheduled_datetime|date:"d.m.Y H:i" }}{% else %}—{% endif %}
                </p>
                {% if is_fan and match.deadline and match.status != 'completed' and match.status != 'walkover' %}
                <p class="text-muted mt-1" style="font-size: var(--font-size-sm);">
                    Если матч не сыгран до дедлайна, тех. победа присуждается игроку с более высоким рейтингом.
                </p>
                {% endif %}
                {% if match.court %}
                <p class="text-secondary">{{ match.court.name }}</p>
                {% endif %}
            </div>

            <div class="d-flex" style="align-items: center; justify-content: center; gap: var(--spacing-2xl); margin-bottom: var(--spacing-xl);">
                <!-- Player/Team 1 -->
                <a href="{% url 'profile' pk=match.get_side1_player.pk %}" class="text-center" style="flex: 1; text-decoration: none; color: inherit;">
                    {% if match.team1 %}{% if match.team1.player1.avatar %}<img src="{{ match.team1.player1.avatar.url }}" alt="" class="player-avatar" style="width: 80px; height: 80px; margin: 0 auto var(--spacing-md);">{% else %}<div class="player-avatar" style="width: 80px; height: 80px; margin: 0 auto var(--spacing-md);"></div>{% endif %}
                    {% else %}{% if match.player1.avatar %}<img src="{{ match.player1.avatar.url }}" alt="" class="player-avatar" style="width: 80px; height: 80px; margin: 0 auto var(--spacing-md);">{% else %}<div class="player-avatar" style="width: 80px; height: 80px; margin: 0 auto var(--spacing-md);"></div>{% endif %}{% endif %}
                    <div class="{% if match.team1 and match.winner_team == match.team1 or match.player1 and match.winner == match.player1 %}text-primary{% endif %}" style="font-weight: 600;">{{ match.get_player1_display }}</div>
                    {% if match.team1 %}<div class="text-muted" style="font-size: var(--font-size-sm);">{{ match.team1.player1.get_skill_level_display }}</div>{% else %}<div class="text-muted" style="font-size: var(--font-size-sm);">{{ match.player1.get_skill_level_display }}</div>{% endif %}
                </a>

                <!-- Score -->
                <div class="text-center">
                    <div style="font-size: var(--font-size-3xl); font-weight: 800; display: flex; gap: var(--spacing-md);">
                        {% if match.status == 'completed' %}
                        <div>
                            {% if match.player1_set1 is not None %}
                            <div class="{% if match.player1_set1 > match.player2_set1 %}text-primary{% endif %}">{{ match.player1_set1 }}</div>
                            <div class="{% if match.player2_set1 > match.player1_set1 %}text-primary{% endif %}">{{ match.player2_set1 }}</div>
                            {% endif %}
                        </div>
                        {% if match.player1_set2 is not None %}
                        <div>
                            <div class="{% if match.player1_set2 > match.player2_set2 %}text-primary{% endif %}">{{ match.player1_set2 }}</div>
                            <div class="{% if match.player2_set2 > match.player1_set2 %}text-primary{% endif %}">{{ match.player2_set2 }}</div>
                        </div>
                        {% endif %}
                        {% if match.player1_set3 is not None %}
                        <div>
                            <div class="{% if match.player1_set3 > match.player2_set3 %}text-primary{% endif %}">{{ match.player1_set3 }}</div>
                            <div class="{% if match.player2_set3 > match.player1_set3 %}text-primary{% endif %}">{{ match.player2_set3 }}</div>
                        </div>
                        {% endif %}
                        {% else %}
                        <span class="text-muted">VS</span>
                        {% endif %}
                    </div>
                    <div class="mt-2 text-secondary" style="font-size: var(--font-size-sm);">{{ match.get_status_display }}</div>
                </div>

                <!-- Player/Team 2 -->
                <a href="{% url 'profile' pk=match.get_side2_player.pk %}" class="text-center" style="flex: 1; text-decoration: none; color: inherit;">
                    {% if match.team2 %}{% if match.team2.player1.avatar %}<img src="{{ match.team2.player1.avatar.url }}" alt="" class="player-avatar" style="width: 80px; height: 80px; margin: 0 auto var(--spacing-md);">{% else %}<div class="player-avatar" style="width: 80px; height: 80px; margin: 0 auto var(--spacing-md);"></div>{% endif %}
                    {% else %}{% if match.player2.avatar %}<img src="{{ match.player2.avatar.url }}" alt="" class="player-avatar" style="width: 80px; height: 80px; margin: 0 auto var(--spacing-md);">{% else %}<div class="player-avatar" style="width: 80px; height: 80px; margin: 0 auto var(--spacing-md);"></div>{% endif %}{% endif %}
                    <div class="{% if match.team2 and match.winner_team == match.team2 or match.player2 and match.winner == match.player2 %}text-primary{% endif %}" style="font-weight: 600;">{{ match.get_player2_display }}</div>
                    {% if match.team2 %}<div class="text-muted" style="font-size: var(--font-size-sm);">{{ match.team2.player1.get_skill_level_display }}</div>{% else %}<div class="text-muted" style="font-size: var(--font-size-sm);">{{ match.player2.get_skill_level_display }}</div>{% endif %}
                </a>
            </div>

            {% if match.winner or match.winner_team %}
            <div class="text-center">
                <p class="text-primary" style="font-weight: 600;">Победитель: {% if match.winner_team %}{{ match.winner_team }}{% else %}{{ match.winner }}{% endif %}</p>
                {% if not is_fan %}
                {% if match.winner_team == match.team1 or match.winner == match.player1 %}
                <p class="text-muted" style="font-size: var(--font-size-sm);">+{{ match.points_player1 }} очков (каждому)</p>
                {% else %}
                <p class="text-muted" style="font-size: var(--font-size-sm);">+{{ match.points_player2 }} очков (каждому)</p>
                {% endif %}
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}