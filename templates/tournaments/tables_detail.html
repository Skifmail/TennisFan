{% extends 'base.html' %}
{% load humanize %}

{% block title %}–¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞: {{ tournament.name }}{% endblock %}

{% block extra_css %}
<style>
.tables-detail .tables-hero-image img { max-width: 100%; height: auto; border-radius: var(--radius-md); }
.tables-detail .tables-description { color: var(--color-text-secondary); font-size: var(--font-size-sm); }
.tables-fan-points { padding: var(--spacing-md); background: var(--color-bg-elevated); border-radius: var(--radius-md); }
.tables-fan-points h4 { font-size: var(--font-size-sm); color: var(--color-text-secondary); }
.fan-points-grid { display: flex; flex-wrap: wrap; gap: var(--spacing-md); font-size: var(--font-size-sm); }
.stats-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--spacing-md); }
.stat-card .card-body { text-align: center; padding: var(--spacing-lg); }
.stat-card-value { display: block; font-size: var(--font-size-2xl); font-weight: 700; color: var(--color-primary); }
.stat-card-label { font-size: var(--font-size-xs); color: var(--color-text-secondary); }
.table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
.standings-table { width: 100%; border-collapse: collapse; min-width: 400px; }
.standings-table th, .standings-table td { padding: var(--spacing-sm) var(--spacing-md); text-align: left; border-bottom: 1px solid var(--color-border-light); }
.standings-table th { font-weight: 600; color: var(--color-text-secondary); font-size: var(--font-size-sm); }
.standings-table tr.top-place { background: rgba(166, 130, 74, 0.08); }
.place-cell { font-weight: 600; width: 50px; }
.player-link { display: flex; align-items: center; gap: var(--spacing-sm); text-decoration: none; color: inherit; }
.player-link:hover { color: var(--color-primary); }
.player-avatar-sm { width: 32px; height: 32px; border-radius: var(--radius-full); object-fit: cover; background: var(--color-bg-elevated); }
.fan-points { font-weight: 600; color: var(--color-primary); }
.charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--spacing-lg); }
.chart-card .chart-title { font-size: var(--font-size-lg); margin-bottom: var(--spacing-md); }
.chart-container { position: relative; height: 250px; }
.matches-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--spacing-md); }
.match-card-mini { display: block; padding: var(--spacing-md); background: var(--color-bg-elevated); border-radius: var(--radius-md); text-decoration: none; color: inherit; transition: background var(--transition-fast); }
.match-card-mini:hover { background: rgba(166, 130, 74, 0.15); }
.match-mini-players { display: flex; flex-direction: column; gap: var(--spacing-xs); }
.match-mini-player { display: flex; align-items: center; gap: var(--spacing-sm); font-size: var(--font-size-sm); }
.match-mini-player.winner { font-weight: 600; color: var(--color-primary); }
.player-avatar-xs { width: 24px; height: 24px; border-radius: var(--radius-full); object-fit: cover; background: var(--color-bg); flex-shrink: 0; }
.match-mini-vs { font-size: var(--font-size-xs); color: var(--color-text-secondary); padding-left: 32px; }
.set-score { margin-left: auto; font-weight: 500; }
.match-mini-status { font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--spacing-xs); }
.round-title { font-size: var(--font-size-lg); margin-bottom: var(--spacing-md); color: var(--color-text-secondary); }
</style>
{% endblock %}

{% block content %}
<div class="container tables-detail" style="padding-top: var(--spacing-2xl);">
    <div class="mb-4">
        <a href="{% url 'tournament_tables_list' %}" class="text-secondary">&larr; –í—Å–µ —Ç—É—Ä–Ω–∏—Ä–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã</a>
    </div>

    <!-- Hero: –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–Ω–∏—Ä–µ -->
    <section class="tables-hero card mb-4">
        <div class="card-body">
            {% if tournament.image %}
            <div class="tables-hero-image mb-3">
                <img src="{{ tournament.image.url }}" alt="{{ tournament.name }}">
            </div>
            {% endif %}
            <div class="d-flex gap-2 mb-2 flex-wrap">
                {% if tournament.format == 'single_elimination' %}
                <span class="player-category" style="background: rgba(70, 130, 180, 0.25); color: #4682b4;">FAN</span>
                {% elif tournament.format == 'olympic_consolation' %}
                <span class="player-category" style="background: rgba(70, 130, 180, 0.25); color: #4682b4;">–û–ª–∏–º–ø–∏–π—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞</span>
                {% elif tournament.format == 'round_robin' %}
                <span class="player-category" style="background: rgba(100, 149, 237, 0.2); color: #6495ed;">–ö—Ä—É–≥–æ–≤–æ–π</span>
                {% endif %}
                {% for ac in tournament.allowed_categories.all %}
                <span class="player-category">{{ ac.get_category_display }}</span>
                {% endfor %}
                <span class="player-category">{{ tournament.get_gender_display }}</span>
                <span class="player-category">{{ tournament.get_duration_display }}</span>
                <span class="player-category">{{ tournament.get_status_display }}</span>
                {% if tournament.entry_fee > 0 %}
                <span class="player-category" style="background: var(--color-bg-elevated);">–í–∑–Ω–æ—Å: {{ tournament.entry_fee|intcomma|cut:".00" }} ‚ÇΩ</span>
                {% else %}
                <span class="player-category" style="background: var(--color-bg-elevated);">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                {% endif %}
            </div>
            <h1 class="page-title" style="text-align: left;">{{ tournament.name }}</h1>
            <p class="text-secondary mb-0">
                {{ tournament.city }} ‚Ä¢ {{ tournament.start_date|date:"d.m.Y" }}
                {% if tournament.end_date %} ‚Äî {{ tournament.end_date|date:"d.m.Y" }}{% endif %}
            </p>
            {% if tournament.description %}
            <div class="tables-description mt-3">
                {{ tournament.description }}
            </div>
            {% endif %}
            {% if is_fan %}
            <div class="tables-fan-points mt-3">
                <h4 class="mb-2">–û—á–∫–∏ FAN –ø–æ —Ä–∞—É–Ω–¥–∞–º</h4>
                <div class="fan-points-grid">
                    <span>1 –∫—Ä—É–≥: {{ tournament.fan_points_r1 }} –æ—á–∫–æ–≤</span>
                    <span>2 –∫—Ä—É–≥: {{ tournament.fan_points_r2 }} –æ—á–∫–æ–≤</span>
                    <span>–ü–æ–ª—É—Ñ–∏–Ω–∞–ª: {{ tournament.fan_points_sf }} –æ—á–∫–æ–≤</span>
                    <span>–§–∏–Ω–∞–ª–∏—Å—Ç: {{ tournament.fan_points_final }} –æ—á–∫–æ–≤</span>
                    <span>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: {{ tournament.fan_points_winner }} –æ—á–∫–æ–≤</span>
                </div>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <section class="tables-stats-cards mb-4">
        <div class="stats-cards-grid">
            <div class="stat-card card">
                <div class="card-body">
                    <span class="stat-card-value">{{ participants_count }}</span>
                    <span class="stat-card-label">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                </div>
            </div>
            <div class="stat-card card">
                <div class="card-body">
                    <span class="stat-card-value">{{ matches_total }}</span>
                    <span class="stat-card-label">–ú–∞—Ç—á–µ–π –≤—Å–µ–≥–æ</span>
                </div>
            </div>
            <div class="stat-card card">
                <div class="card-body">
                    <span class="stat-card-value">{{ matches_completed }}</span>
                    <span class="stat-card-label">–ú–∞—Ç—á–µ–π —Å—ã–≥—Ä–∞–Ω–æ</span>
                </div>
            </div>
            <div class="stat-card card">
                <div class="card-body">
                    <span class="stat-card-value">{{ progress_pct }}%</span>
                    <span class="stat-card-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                </div>
            </div>
        </div>
    </section>

    {% if participants_count > 0 %}
    <!-- –¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
    <section class="tables-section card mb-4">
        <div class="card-body">
            <h2 class="section-title mb-3">–¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h2>
            <div class="table-responsive">
                <table class="standings-table">
                    <thead>
                        <tr>
                            <th>–ú–µ—Å—Ç–æ</th>
                            <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                            <th>–†–µ–π—Ç–∏–Ω–≥</th>
                            {% if is_fan %}
                            <th>–†–∞—É–Ω–¥ –≤—ã–ª–µ—Ç–∞</th>
                            <th>–û—á–∫–∏ FAN</th>
                            {% elif is_olympic %}
                            <th>–û—á–∫–∏ –∑–∞ –º–µ—Å—Ç–æ</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in standings %}
                        <tr class="{% if s.place <= 3 %}top-place{% endif %}">
                            <td class="place-cell">
                                {% if s.place == 1 %}ü•á{% elif s.place == 2 %}ü•à{% elif s.place == 3 %}ü•â{% else %}{{ s.place }}{% endif %}
                            </td>
                            <td>
                                {% if s.team %}
                                <a href="{% url 'profile' pk=s.team.player1.pk %}" class="player-link">
                                    {% if s.team.player1.avatar %}
                                    <img src="{{ s.team.player1.avatar.url }}" alt="" class="player-avatar-sm">
                                    {% else %}
                                    <div class="player-avatar-sm"></div>
                                    {% endif %}
                                    {{ s.team }}
                                </a>
                                {% else %}
                                <a href="{% url 'profile' pk=s.player.pk %}" class="player-link">
                                    {% if s.player.avatar %}
                                    <img src="{{ s.player.avatar.url }}" alt="" class="player-avatar-sm">
                                    {% else %}
                                    <div class="player-avatar-sm"></div>
                                    {% endif %}
                                    {{ s.player.user.first_name }} {{ s.player.user.last_name }}
                                </a>
                                {% endif %}
                            </td>
                            <td>{% if s.team %}{{ s.team.player1.total_points }}{% else %}{{ s.player.total_points }}{% endif %}</td>
                            {% if is_fan %}
                            <td>{{ s.round_eliminated }}</td>
                            <td class="fan-points">{{ s.fan_points }}</td>
                            {% elif is_olympic %}
                            <td class="fan-points">{{ s.fan_points }}</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <section class="tables-charts mb-4">
        <div class="charts-grid">
            {% if chart_status_labels %}
            <div class="chart-card card">
                <div class="card-body">
                    <h3 class="chart-title">–°—Ç–∞—Ç—É—Å –º–∞—Ç—á–µ–π</h3>
                    <div class="chart-container">
                        <canvas id="chartStatus"></canvas>
                    </div>
                </div>
            </div>
            {% endif %}
            {% if is_fan and chart_round_labels %}
            <div class="chart-card card">
                <div class="card-body">
                    <h3 class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–∞—É–Ω–¥–∞–º –≤—ã–ª–µ—Ç–∞</h3>
                    <div class="chart-container">
                        <canvas id="chartRounds"></canvas>
                    </div>
                </div>
            </div>
            {% endif %}
            {% if ratings_sorted %}
            <div class="chart-card card">
                <div class="card-body">
                    <h3 class="chart-title">–†–µ–π—Ç–∏–Ω–≥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—Ç–æ–ø-20)</h3>
                    <div class="chart-container">
                        <canvas id="chartRatings"></canvas>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- –ú–∞—Ç—á–∏ –ø–æ —Ä–∞—É–Ω–¥–∞–º -->
    <section class="tables-matches card mb-4">
        <div class="card-body">
            <h2 class="section-title mb-3">–ú–∞—Ç—á–∏ –ø–æ —Ä–∞—É–Ω–¥–∞–º</h2>
            {% for round_name, is_consolation, round_matches in matches_by_round %}
            <div class="matches-round mb-4">
                <h3 class="round-title">{{ round_name }}{% if is_consolation %} <span class="text-muted">(–ø–æ–¥–≤–∞–ª)</span>{% endif %}</h3>
                <div class="matches-grid">
                    {% for match in round_matches %}
                    <a href="{% url 'match_detail' pk=match.pk %}" class="match-card-mini">
                        <div class="match-mini-players">
                            <div class="match-mini-player {% if match.team1 and match.winner_team == match.team1 or match.player1 and match.winner == match.player1 %}winner{% endif %}">
                                {% if match.team1 %}{% if match.team1.player1.avatar %}<img src="{{ match.team1.player1.avatar.url }}" alt="" class="player-avatar-xs">{% else %}<div class="player-avatar-xs"></div>{% endif %}
                                {% else %}{% if match.player1.avatar %}<img src="{{ match.player1.avatar.url }}" alt="" class="player-avatar-xs">{% else %}<div class="player-avatar-xs"></div>{% endif %}{% endif %}
                                <span>{% if match.team1 %}{{ match.team1 }}{% elif match.player1.is_bye %}–°–≤–æ–±–æ–¥–Ω—ã–π –∫—Ä—É–≥{% else %}{{ match.player1 }}{% endif %}</span>
                                {% if match.player1_set1 is not None %}<span class="set-score">{{ match.player1_set1 }}{% if match.player1_set2 is not None %}:{{ match.player1_set2 }}{% if match.player1_set3 is not None %}:{{ match.player1_set3 }}{% endif %}{% endif %}</span>{% endif %}
                            </div>
                            <div class="match-mini-vs">vs</div>
                            <div class="match-mini-player {% if match.team2 and match.winner_team == match.team2 or match.player2 and match.winner == match.player2 %}winner{% endif %}">
                                {% if match.team2 %}{% if match.team2.player1.avatar %}<img src="{{ match.team2.player1.avatar.url }}" alt="" class="player-avatar-xs">{% else %}<div class="player-avatar-xs"></div>{% endif %}
                                {% else %}{% if match.player2.avatar %}<img src="{{ match.player2.avatar.url }}" alt="" class="player-avatar-xs">{% else %}<div class="player-avatar-xs"></div>{% endif %}{% endif %}
                                <span>{% if match.team2 %}{{ match.team2 }}{% elif match.player2.is_bye %}–°–≤–æ–±–æ–¥–Ω—ã–π –∫—Ä—É–≥{% else %}{{ match.player2 }}{% endif %}</span>
                                {% if match.player2_set1 is not None %}<span class="set-score">{{ match.player2_set1 }}{% if match.player2_set2 is not None %}:{{ match.player2_set2 }}{% if match.player2_set3 is not None %}:{{ match.player2_set3 }}{% endif %}{% endif %}</span>{% endif %}
                            </div>
                        </div>
                        <div class="match-mini-status">{{ match.get_status_display }}</div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% empty %}
            <p class="text-secondary">–ú–∞—Ç—á–∏ –µ—â—ë –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã.</p>
            {% endfor %}
        </div>
    </section>

    <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç—É—Ä–Ω–∏—Ä–∞ -->
    <div class="text-center mb-4">
        <a href="{% url 'tournament_detail' slug=tournament.slug %}" class="btn btn-primary">–û—Ç–∫—Ä—ã—Ç—å —Ç—É—Ä–Ω–∏—Ä (—Å–µ—Ç–∫–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chartColors = {
        primary: '#A6824A',
        accent: '#83530cd3',
        palette: ['#A6824A', '#83530c', '#2d5a27', '#6b7280', '#9ca3af']
    };

    {% if chart_status_labels %}
    new Chart(document.getElementById('chartStatus'), {
        type: 'doughnut',
        data: {
            labels: {{ chart_status_labels|safe }},
            datasets: [{
                data: {{ chart_status_data|safe }},
                backgroundColor: chartColors.palette,
                borderColor: '#16302B',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });
    {% endif %}

    {% if is_fan and chart_round_labels %}
    new Chart(document.getElementById('chartRounds'), {
        type: 'bar',
        data: {
            labels: {{ chart_round_labels|safe }},
            datasets: [{
                label: '–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤',
                data: {{ chart_round_data|safe }},
                backgroundColor: chartColors.primary,
                borderColor: chartColors.accent,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });
    {% endif %}

    {% if ratings_sorted %}
    new Chart(document.getElementById('chartRatings'), {
        type: 'bar',
        data: {
            labels: {{ ratings_labels|safe }},
            datasets: [{
                label: '–†–µ–π—Ç–∏–Ω–≥',
                data: {{ ratings_sorted|safe }},
                backgroundColor: 'rgba(166, 130, 74, 0.6)',
                borderColor: chartColors.primary,
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
        }
    });
    {% endif %}
});
</script>
{% endblock %}
