{% extends 'base.html' %}
{% load static %}

{% block title %}{{ player }} - Профиль{% endblock %}

{% block content %}
<div class="container" style="padding-top: var(--spacing-2xl);">
    <!-- Profile Card -->
    <div class="card profile-card">
            {% if player.paid_subscription_tier %}
            <div class="subscription-badge-wrap subscription-badge-wrap--card">
                {% include 'includes/subscription_badge.html' with tier=player.paid_subscription_tier %}
            </div>
            {% endif %}
            <div class="card-body text-center">
                {% if player.avatar %}
                <img src="{{ player.avatar.url }}" alt="" class="player-avatar"
                    style="width: 120px; height: 120px; margin: 0 auto var(--spacing-lg);">
                {% else %}
                <div class="player-avatar" style="width: 120px; height: 120px; margin: 0 auto var(--spacing-lg);"></div>
                {% endif %}

                <h1 style="font-size: var(--font-size-xl); margin-bottom: var(--spacing-sm);">{{ player }}</h1>
                <span class="player-category">{{ player.get_skill_level_display }}</span>

                <div class="mt-3 text-secondary" style="font-size: var(--font-size-sm);">
                    {% if request.user == player.user %}
                    <p><strong>Ваш ID в системе:</strong> <code>{{ player.id }}</code></p>
                    {% endif %}
                    <p><strong>Город:</strong> {{ player.city }}</p>
                    <p><strong>Уровень:</strong> {{ player.get_skill_level_display }}</p>
                    <p><strong>Дата рождения:</strong> {{ player.birth_date|date:"d.m.Y" }}</p>
                    {% if player.calculated_age %}<p><strong>Возраст:</strong> {{ player.calculated_age }} лет</p>{% endif %}
                    <p><strong>Пол:</strong> {{ player.get_gender_display }}</p>
                    <p><strong>Forehand:</strong> {{ player.get_forehand_display }}</p>
                </div>

                <div class="player-stats mt-3" style="justify-content: center;">
                    <div>
                        <div class="stat-value">{{ player.total_points }}</div>
                        <div class="stat-label">Очков</div>
                    </div>
                    <div>
                        <div class="stat-value">{{ player.matches_played }}</div>
                        <div class="stat-label">Матчей</div>
                    </div>
                    <div>
                        <div class="stat-value">{{ player.win_rate }}%</div>
                        <div class="stat-label">Побед</div>
                    </div>
                </div>

                {% if player.bio %}
                <p class="mt-3 text-secondary" style="font-size: var(--font-size-sm);">{{ player.bio }}</p>
                {% endif %}

                {% if player.telegram_url or player.whatsapp_url or player.max_url %}
                <div class="mt-3">
                    {% include 'includes/messenger_links.html' with obj=player %}
                </div>
                {% endif %}

                {% if request.user == player.user %}
                    {% if player.user.subscription %}
                    <div class="subscription-info mt-3" style="text-align: left; background: var(--color-bg-secondary); padding: var(--spacing-sm); border-radius: var(--border-radius-md); font-size: 0.9em; border: 1px solid var(--color-border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="color: var(--color-text-muted);">Тариф:</span>
                            <strong style="color: var(--color-primary);">{{ player.user.subscription.tier.get_name_display }}</strong>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="color: var(--color-text-muted);">Статус:</span>
                            {% if player.user.subscription.is_valid %}
                                <span class="badge badge-success" style="background-color: var(--color-success); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">Активна</span>
                            {% else %}
                                <span class="badge badge-danger" style="background-color: var(--color-error); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">Истекла</span>
                            {% endif %}
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="color: var(--color-text-muted);">Истекает:</span>
                            <span>{{ player.user.subscription.end_date|date:"d.m.Y" }}</span>
                        </div>

                        {% if not player.user.subscription.tier.is_unlimited and player.user.subscription.is_valid %}
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--color-border-light);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <span style="color: var(--color-text-muted);">Лимит:</span>
                                <span>{{ player.user.subscription.tournaments_registered_count }} / {{ player.user.subscription.tier.max_tournaments }}</span>
                            </div>
                            <div style="background: var(--color-border-light); height: 4px; border-radius: 2px; overflow: hidden;">
                                <div style="background: var(--color-primary); height: 100%; width: {% widthratio player.user.subscription.tournaments_registered_count player.user.subscription.tier.max_tournaments 100 %}%;"></div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if not player.user.subscription.is_valid %}
                            <a href="{% url 'pricing' %}" class="btn btn-sm btn-outline mt-2" style="width: 100%;">Продлить</a>
                        {% endif %}
                    </div>
                    {% else %}
                     <div class="alert alert-warning mt-3" style="font-size: var(--font-size-sm); text-align: left;">
                        У вас нет активной платной подписки. <a href="{% url 'pricing' %}">Купить</a>
                    </div>
                    {% endif %}
                <a href="{% url 'profile_edit' %}" class="btn btn-primary mt-3" style="width: 100%;">Редактировать</a>
                {% endif %}
                {% if request.user == player.user %}
                <a href="{% url 'ntrp_test' %}" class="btn btn-outline mt-2" style="width: 100%;">Пройти NTRP тест</a>
                {% endif %}
            </div>
    </div>

    <!-- Recent Matches -->
    <div>
        <h2 class="section-title mb-3">Последние матчи</h2>
        <div class="grid grid-2">
                {% for match in recent_matches %}
                <a href="{% url 'match_detail' pk=match.pk %}" class="match-card">
                    <div class="match-header">
                        <span class="match-tournament">{{ match.tournament.name }}</span>
                        <span class="match-date">{{ match.scheduled_datetime|date:"d.m.Y" }}</span>
                    </div>
                    <div class="match-score-table-wrap">
                        <table class="match-score-table">
                            <thead>
                                <tr>
                                    <th>Игрок</th>
                                    <th>Сет 1</th>
                                    <th>Сет 2</th>
                                    <th>Сет 3</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="{% if match.winner == match.player1 %}winner-row{% endif %}">
                                    <td class="player-cell">
                                        <span class="player-name">{{ match.player1 }}</span>
                                        {% if match.winner == match.player1 %}
                                            {% if match.status == 'completed' or match.status == 'walkover' %}
                                            <span class="win-badge">WIN</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>{{ match.player1_set1|default:"—" }}</td>
                                    <td>{{ match.player1_set2|default:"—" }}</td>
                                    <td>{{ match.player1_set3|default:"—" }}</td>
                                </tr>
                                <tr class="{% if match.winner == match.player2 %}winner-row{% endif %}">
                                    <td class="player-cell">
                                        <span class="player-name">{{ match.player2 }}</span>
                                        {% if match.winner == match.player2 %}
                                            {% if match.status == 'completed' or match.status == 'walkover' %}
                                            <span class="win-badge">WIN</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>{{ match.player2_set1|default:"—" }}</td>
                                    <td>{{ match.player2_set2|default:"—" }}</td>
                                    <td>{{ match.player2_set3|default:"—" }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </a>
            {% empty %}
            <p class="text-secondary">Нет матчей.</p>
            {% endfor %}
        </div>
    </div>
</div>

<style>
@media (max-width: 768px) {
    .container > .card {
        max-width: 100%;
    }
}
</style>

{% endblock %}