{% extends 'base.html' %}

{% block title %}Регистрация{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Регистрация</h1>
    <p class="page-subtitle">Присоединяйтесь к теннисному сообществу</p>
</div>

<div class="container" style="max-width: 600px;">
    <div class="card mb-4">
        <div class="card-body" style="padding: var(--spacing-2xl);">
            <form method="post" id="register-form">
                {% csrf_token %}

                <div class="form-group">
                    <label class="form-label" for="id_last_name">{{ form.last_name.label }}</label>
                    {{ form.last_name }}
                    {% for error in form.last_name.errors %}<p class="text-error" style="margin-top: var(--spacing-xs); font-size: var(--font-size-sm);">{{ error }}</p>{% endfor %}
                </div>
                <div class="form-group">
                    <label class="form-label" for="id_first_name">{{ form.first_name.label }}</label>
                    {{ form.first_name }}
                    {% for error in form.first_name.errors %}<p class="text-error" style="margin-top: var(--spacing-xs); font-size: var(--font-size-sm);">{{ error }}</p>{% endfor %}
                </div>
                <div class="form-group">
                    <label class="form-label" for="id_phone">{{ form.phone.label }}</label>
                    {{ form.phone }}
                    <div class="field-error" id="phone-error" style="display: none; margin-top: var(--spacing-xs); font-size: var(--font-size-sm); color: var(--color-error);"></div>
                    {% for error in form.phone.errors %}<p class="text-error" style="margin-top: var(--spacing-xs); font-size: var(--font-size-sm);">{{ error }}</p>{% endfor %}
                </div>
                <div class="form-group">
                    <label class="form-label" for="id_email">{{ form.email.label }}</label>
                    {{ form.email }}
                    <div class="field-error" id="email-error" style="display: none; margin-top: var(--spacing-xs); font-size: var(--font-size-sm); color: var(--color-error);"></div>
                    {% for error in form.email.errors %}<p class="text-error" style="margin-top: var(--spacing-xs); font-size: var(--font-size-sm);">{{ error }}</p>{% endfor %}
                </div>
                <div class="form-group">
                    <label class="form-label" for="id_birth_date">{{ form.birth_date.label }}</label>
                    {{ form.birth_date }}
                    <div class="field-error" id="birth_date-error" style="display: none; margin-top: var(--spacing-xs); font-size: var(--font-size-sm); color: var(--color-error);"></div>
                    {% for error in form.birth_date.errors %}<p class="text-error" style="margin-top: var(--spacing-xs); font-size: var(--font-size-sm);">{{ error }}</p>{% endfor %}
                </div>
                <div class="form-group">
                    <label class="form-label" for="id_city">{{ form.city.label }}</label>
                    {{ form.city }}
                    <div class="field-error" id="city-error" style="display: none; margin-top: var(--spacing-xs); font-size: var(--font-size-sm); color: var(--color-error);"></div>
                    {% for error in form.city.errors %}<p class="text-error" style="margin-top: var(--spacing-xs); font-size: var(--font-size-sm);">{{ error }}</p>{% endfor %}
                </div>
                <div class="form-group">
                    <label class="form-label" for="id_password">{{ form.password.label }}</label>
                    {{ form.password }}
                    <div class="field-error" id="password-error" style="display: none; margin-top: var(--spacing-xs); font-size: var(--font-size-sm); color: var(--color-error);"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="id_password_confirm">{{ form.password_confirm.label }}</label>
                    {{ form.password_confirm }}
                    <div class="field-error" id="password_confirm-error" style="display: none; margin-top: var(--spacing-xs); font-size: var(--font-size-sm); color: var(--color-error);"></div>
                    {% for error in form.password_confirm.errors %}<p class="text-error" style="margin-top: var(--spacing-xs); font-size: var(--font-size-sm);">{{ error }}</p>{% endfor %}
                </div>

                <hr style="margin: var(--spacing-xl) 0; border: none; border-top: 1px solid var(--color-border);">

                <h3 style="margin-bottom: var(--spacing-md); font-size: var(--font-size-lg);">NTRP-тест</h3>
                <p class="text-secondary" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-lg);">Пройдите тест и нажмите «Рассчитать» перед регистрацией.</p>
                {{ form.ntrp_level }}

                {% include 'users/_ntrp_quiz.html' with can_save=False form_target='id_ntrp_level' %}

                <hr style="margin: var(--spacing-xl) 0; border: none; border-top: 1px solid var(--color-border);">

                <div class="form-group form-group-consent">
                    <label class="consent-label">
                        {{ form.agree_legal }}
                        <span class="consent-text">Я согласен на <a href="{% url 'legal_personal_data' %}" target="_blank" rel="noopener">обработку персональных данных</a> и <a href="{% url 'legal_privacy' %}" target="_blank" rel="noopener">Политику конфиденциальности</a></span>
                    </label>
                    {% for error in form.agree_legal.errors %}<p class="text-error" style="margin-top: var(--spacing-xs); font-size: var(--font-size-sm);">{{ error }}</p>{% endfor %}
                </div>

                <div class="field-error" id="ntrp-error" style="display: none; margin-bottom: var(--spacing-md); font-size: var(--font-size-sm); color: var(--color-error);"></div>
                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">Зарегистрироваться</button>

                <p class="text-center mt-3 text-secondary">
                    Уже есть аккаунт? <a href="{% url 'login' %}" class="text-primary">Войти</a>
                </p>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('register-form');
    const emailField = document.getElementById('id_email');
    const phoneField = document.getElementById('id_phone');
    const passwordField = document.getElementById('id_password');
    const passwordConfirmField = document.getElementById('id_password_confirm');
    const birthDateField = document.getElementById('id_birth_date');
    const cityField = document.getElementById('id_city');
    const ntrpField = document.getElementById('id_ntrp_level');
    const emailError = document.getElementById('email-error');
    const phoneError = document.getElementById('phone-error');
    const passwordError = document.getElementById('password-error');
    const passwordConfirmError = document.getElementById('password_confirm-error');
    const birthDateError = document.getElementById('birth_date-error');
    const cityError = document.getElementById('city-error');
    const ntrpError = document.getElementById('ntrp-error');

    function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email || '');
    }
    function validatePhone(phone) {
        const s = (phone || '').trim();
        return s !== '' && s !== '+7' && /^\+7\d{10}$/.test(s);
    }
    function validateBirthDate(date) {
        if (!date) return false;
        const d = new Date(date);
        const today = new Date();
        const min = new Date(today.getFullYear() - 100, today.getMonth(), today.getDate());
        const max = new Date(today.getFullYear() - 5, today.getMonth(), today.getDate());
        return d >= min && d <= max;
    }

    function showError(el, msg) {
        if (!el) return;
        el.textContent = msg;
        el.style.display = 'block';
    }
    function hideError(el) {
        if (!el) return;
        el.style.display = 'none';
    }

    [emailField, phoneField, passwordField, passwordConfirmField, birthDateField, cityField].forEach(function(f) {
        if (!f) return;
        f.addEventListener('input', function() {
            var g = this.closest('.form-group');
            if (g) g.querySelectorAll('.text-error').forEach(function(e) { e.remove(); });
            hideError(document.getElementById(this.id.replace('id_', '') + '-error'));
        });
    });

    if (phoneField) {
        phoneField.addEventListener('blur', function() {
            if (!validatePhone(this.value)) showError(phoneError, 'Укажите телефон +7XXXXXXXXXX.');
            else hideError(phoneError);
        });
    }
    if (emailField) {
        emailField.addEventListener('blur', function() {
            var v = this.value.trim();
            if (!v) showError(emailError, 'Email обязателен.');
            else if (!validateEmail(v)) showError(emailError, 'Введите корректный email.');
            else hideError(emailError);
        });
    }
    if (birthDateField) {
        birthDateField.addEventListener('change', function() {
            if (!this.value) showError(birthDateError, 'Укажите дату рождения.');
            else if (!validateBirthDate(this.value)) showError(birthDateError, 'Дата: от 5 до 100 лет.');
            else hideError(birthDateError);
        });
    }
    if (cityField) {
        cityField.addEventListener('blur', function() {
            if (!this.value.trim()) showError(cityError, 'Укажите город.');
            else hideError(cityError);
        });
    }

    if (form) {
        form.addEventListener('submit', function(e) {
            var has = false;
            hideError(ntrpError);
            if (!emailField || !emailField.value.trim()) { showError(emailError, 'Email обязателен.'); has = true; }
            else if (!validateEmail(emailField.value.trim())) { showError(emailError, 'Введите корректный email.'); has = true; }
            if (!validatePhone(phoneField ? phoneField.value : '')) { showError(phoneError, 'Укажите телефон +7XXXXXXXXXX.'); has = true; }
            if (!passwordField || !passwordField.value || passwordField.value.length < 8) { showError(passwordError, 'Пароль не менее 8 символов.'); has = true; }
            if (passwordConfirmField && (!passwordConfirmField.value || passwordConfirmField.value !== passwordField.value)) { showError(passwordConfirmError, 'Пароли не совпадают.'); has = true; }
            if (!birthDateField || !birthDateField.value || !validateBirthDate(birthDateField.value)) { showError(birthDateError, 'Укажите дату рождения.'); has = true; }
            if (!cityField || !cityField.value.trim()) { showError(cityError, 'Укажите город.'); has = true; }
            var nv = ntrpField ? (ntrpField.value || '').trim() : '';
            if (!nv || nv < 1 || nv > 7) { showError(ntrpError, 'Пройдите NTRP-тест и нажмите «Рассчитать».'); has = true; }
            if (has) { e.preventDefault(); return; }
        });
    }
});
</script>
{% endblock %}
